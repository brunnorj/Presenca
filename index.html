<!-- ... todo o código HTML e CSS continua o mesmo ... -->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vôlei da Vila com Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300..700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Teko', sans-serif;
        }
        .bg-pattern {
            background-color: #001f3f;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .tab-button.active {
            background-color: #FBBF24;
            color: #001f3f;
            border-bottom: 4px solid #ffffff;
        }
        .slot {
            transition: all 0.3s ease;
        }
        .slot-free {
            background-color: #22c55e;
            color: white;
            cursor: pointer;
        }
        .slot-free:hover {
            background-color: #16a34a;
            transform: translateY(-2px);
        }
        .slot-taken {
            background-color: #4b5563;
            color: #e5e7eb;
            cursor: not-allowed;
        }
        .slot-mine {
            background-color: #FBBF24;
            color: #001f3f;
            border: 2px solid white;
            font-weight: 900;
            cursor: pointer;
        }
        .slot-mine:hover {
            background-color: #F59E0B;
            transform: translateY(-2px);
        }
        /* ESTILO PARA CONVIDADOS */
        .slot-guest, .slot-guest-mine {
            background-color: #38bdf8; /* Azul claro */
            color: #001f3f;
            border: 2px solid white;
        }
        .slot-guest-mine {
            cursor: pointer;
            font-weight: 900;
        }
        .slot-guest-mine:hover {
            background-color: #0ea5e9;
            transform: translateY(-2px);
        }

        .admin-view .slot-taken,
        .admin-view .slot-mine,
        .admin-view .slot-guest,
        .admin-view .slot-guest-mine {
            cursor: pointer;
        }
        .admin-view .slot-taken:hover,
        .admin-view .slot-mine:hover,
        .admin-view .slot-guest:hover,
        .admin-view .slot-guest-mine:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .slot-paused {
            background-color: #6b7280;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .font-brand {
            font-family: 'Teko', sans-serif;
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.flex {
            display: flex;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.5);
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-pattern text-white min-h-screen">

    <!-- Tela de Login -->
    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-sm p-8 space-y-6 bg-gray-800 bg-opacity-80 rounded-2xl shadow-lg border border-gray-700">
            <div class="text-center">
                 <img src="https://placehold.co/100x100/FBBF24/001f3f?text=VV" alt="Logo Vôlei da Vila" class="mx-auto mb-4 rounded-full border-4 border-amber-400">
                <h1 class="text-5xl font-brand font-bold text-amber-400">VÔLEI DA VILA</h1>
                <p class="text-gray-300">Faça o login para continuar</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="sr-only">Utilizador</label>
                    <input type="text" id="username" name="username" placeholder="Nome de Utilizador" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-400" required>
                </div>
                <div>
                    <label for="password" class="sr-only">Senha</label>
                    <input type="password" id="password" name="password" placeholder="Senha" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-400" required>
                </div>
                <p id="login-error" class="text-red-500 text-center text-sm hidden">Utilizador ou senha inválidos.</p>
                <button type="submit" class="w-full px-4 py-3 font-bold text-lg bg-amber-400 text-gray-900 rounded-lg hover:bg-amber-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-amber-400 transition-colors duration-300">
                    ENTRAR
                </button>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal do Site -->
    <div id="app-screen" class="hidden">
        <header class="bg-gray-900 bg-opacity-70 p-4 shadow-lg sticky top-0 z-20 backdrop-blur-sm">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-4xl font-brand font-bold text-amber-400">VÔLEI DA VILA</h1>
                <div class="flex items-center space-x-4">
                    <span id="welcome-message" class="text-lg text-gray-300"></span>
                    <button id="change-password-button" class="px-4 py-2 text-sm font-bold bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">ALTERAR SENHA</button>
                    <button id="logout-button" class="px-4 py-2 text-sm font-bold bg-red-600 rounded-lg hover:bg-red-700 transition-colors">SAIR</button>
                </div>
            </div>
        </header>
        
        <nav class="bg-gray-800">
            <div class="container mx-auto flex justify-center flex-wrap">
                <button data-tab="presenca" class="tab-button text-2xl font-bold py-4 px-6 active">Presença</button>
                <button data-tab="torneio" class="tab-button text-2xl font-bold py-4 px-6">Torneio</button>
                <button data-tab="informacoes" class="tab-button text-2xl font-bold py-4 px-6">Informações</button>
                <button data-tab="album" class="tab-button text-2xl font-bold py-4 px-6">Álbum</button>
                <button id="admin-tab-button" data-tab="cadastro" class="tab-button text-2xl font-bold py-4 px-6 hidden">Gestão</button>
            </div>
        </nav>

        <main class="container mx-auto p-4 md:p-8">
            <!-- Aba de Presença -->
            <div id="presenca" class="tab-content">
                <div class="text-center mb-8">
                    <h2 class="text-5xl font-brand font-bold text-white">LISTA DE PRESENÇA</h2>
                    <p class="text-xl text-gray-400">Marque a sua presença para o dia ativo.</p>
                    <!-- BOTÃO CONVIDADO ADICIONADO -->
                    <div id="guest-controls" class="mt-4 hidden">
                        <button id="add-guest-button" class="px-6 py-2 font-bold text-lg bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors">
                            LEVAR CONVIDADO
                        </button>
                    </div>
                </div>

                <div id="admin-date-selector" class="hidden flex-col items-center gap-4 mb-8">
                    <label for="presence-date" class="text-2xl font-bold">Ativar data para marcação:</label>
                    <input type="date" id="presence-date" class="bg-gray-700 border border-gray-600 rounded-lg p-3 text-white text-xl focus:outline-none focus:ring-2 focus:ring-amber-400">
                    <div id="admin-controls" class="flex flex-wrap justify-center gap-4 mt-2">
                        <button id="pause-date-button" class="px-4 py-2 font-bold bg-yellow-600 rounded-lg hover:bg-yellow-700 transition-colors">Pausar Marcações</button>
                        <button id="delete-presences-button" class="px-4 py-2 font-bold bg-red-800 rounded-lg hover:bg-red-900 transition-colors">Excluir Presenças</button>
                        <!-- BOTÃO RELATÓRIO ADICIONADO -->
                        <button id="generate-report-button" class="px-4 py-2 font-bold bg-green-600 rounded-lg hover:bg-green-700 transition-colors">Gerar Relatório</button>
                    </div>
                </div>

                <div id="player-date-display" class="text-center mb-8 hidden"></div>

                <div id="presence-list-container" class="hidden">
                     <h3 id="selected-date-title" class="text-4xl font-brand text-amber-400 text-center mb-6"></h3>
                     <div id="presence-slots" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 bg-gray-800 bg-opacity-50 rounded-2xl p-6 border border-gray-700"></div>
                </div>
            </div>

            <!-- Outras Abas (sem alterações de lógica) -->
            <div id="torneio" class="tab-content hidden"><div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700"><h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">TORNEIOS</h2><p class="text-xl text-center text-gray-300">Em breve, informações sobre o nosso próximo torneio de integração.</p></div></div>
            <div id="informacoes" class="tab-content hidden"><div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700"><h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">INFORMAÇÕES GERAIS</h2><ul class="text-xl text-gray-300 space-y-4 list-disc list-inside"><li><strong>Dias de Jogo:</strong> Terças, Quintas e Sábado.</li><li><strong>Horário:</strong> Das 20:00 às 22:00 (Terça e Quinta) e Das 15:00 às 18:00 (Sábado)</li><li><strong>Local:</strong> R. Bento Gonçalves, 457A - Encantado, Rio de Janeiro - RJ, 20755-000.</li><li><strong>Regras:</strong> Respeito acima de tudo.</li></ul></div></div>
            <div id="album" class="tab-content hidden"><div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700"><h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">ÁLBUM DE FOTOS</h2><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"><img src="https://placehold.co/400x300/001f3f/FBBF24?text=Volei" alt="Foto da equipa" class="rounded-lg shadow-lg"><img src="https://placehold.co/400x300/001f3f/FBBF24?text=Jogo" alt="Foto da equipa" class="rounded-lg shadow-lg"></div></div></div>
            
            <!-- Aba de Cadastro (Admin) -->
            <div id="cadastro" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700">
                        <h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">CADASTRAR JOGADOR</h2>
                        <form id="registration-form" class="space-y-6">
                             <div>
                                <label for="new-username" class="text-xl text-gray-300">Nome do Jogador</label>
                                <input type="text" id="new-username" name="new-username" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                            </div>
                            <div>
                                <label for="new-password" class="text-xl text-gray-300">Senha</label>
                                <input type="password" id="new-password" name="new-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                            </div>
                            <div>
                                 <label for="user-role" class="text-xl text-gray-300">Perfil de Acesso</label>
                                 <select id="user-role" name="user-role" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                     <option value="padrão">Padrão</option>
                                     <option value="administrador">Administrador</option>
                                 </select>
                            </div>
                            <p id="registration-message" class="text-center text-lg"></p>
                            <button type="submit" class="w-full px-4 py-3 font-bold text-lg bg-amber-400 text-gray-900 rounded-lg hover:bg-amber-500">CADASTRAR</button>
                        </form>
                    </div>
                    <div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700">
                        <h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">GERIR JOGADORES</h2>
                        <div id="user-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="presence-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600 text-center"><h2 id="modal-title" class="text-3xl font-brand text-amber-400">Confirmar Presença</h2><p id="modal-confirm-text" class="text-lg text-gray-200"></p><div class="flex gap-4"><button id="confirm-presence-button" class="w-full py-3 font-bold bg-green-600 rounded-lg hover:bg-green-700">CONFIRMAR</button><button id="cancel-presence-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg hover:bg-gray-500">CANCELAR</button></div></div></div>
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 id="message-title" class="text-3xl font-brand text-amber-400">Aviso</h2><p id="message-text" class="text-lg text-gray-200"></p><button id="message-ok-button" class="px-8 py-2 font-bold bg-amber-400 text-gray-900 rounded-lg hover:bg-amber-500">OK</button></div></div></div>
    <div id="unconfirm-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 class="text-3xl font-brand text-amber-400">Remover Presença</h2><p id="unconfirm-modal-text" class="text-lg text-gray-200"></p><div class="flex gap-4"><button id="confirm-unmark-button" class="w-full py-3 font-bold bg-red-600 rounded-lg hover:bg-red-700">SIM, REMOVER</button><button id="cancel-unmark-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg hover:bg-gray-500">CANCELAR</button></div></div></div>
    <div id="admin-action-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 id="admin-action-title" class="text-3xl font-brand text-amber-400">Ação de Administrador</h2><p id="admin-action-text" class="text-lg text-gray-200"></p><div class="flex flex-col gap-4"><button id="admin-action-remove-button" class="w-full py-3 font-bold bg-red-600 rounded-lg hover:bg-red-700">Remover Presença</button><button id="admin-action-penalty-button" class="w-full py-3 font-bold bg-yellow-600 text-gray-900 rounded-lg hover:bg-yellow-700">Aplicar Penalidade</button><button id="admin-action-cancel-button" class="w-full py-2 font-bold bg-gray-600 rounded-lg hover:bg-gray-500 mt-2">Cancelar</button></div></div></div>
    <div id="penalty-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 id="penalty-title" class="text-3xl font-brand text-yellow-500">Aplicar Penalidade</h2><p id="penalty-text" class="text-lg text-gray-200"></p><div class="flex flex-col gap-4"><button data-penalty="7" class="penalty-duration-button w-full py-3 font-bold bg-yellow-600 text-gray-900 rounded-lg">1 Semana</button><button data-penalty="30" class="penalty-duration-button w-full py-3 font-bold bg-orange-600 text-gray-900 rounded-lg">1 Mês</button><button id="penalty-cancel-button" class="w-full py-2 font-bold bg-gray-600 rounded-lg hover:bg-gray-500 mt-2">Cancelar</button></div></div></div>
    <div id="delete-user-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 class="text-3xl font-brand text-red-500">Excluir Jogador</h2><p id="delete-user-text" class="text-lg text-gray-200"></p><div class="flex gap-4"><button id="confirm-delete-user-button" class="w-full py-3 font-bold bg-red-600 rounded-lg hover:bg-red-700">SIM, EXCLUIR</button><button id="cancel-delete-user-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg hover:bg-gray-500">CANCELAR</button></div></div></div>
    <div id="delete-presences-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 class="text-3xl font-brand text-red-500">Excluir Presenças</h2><p id="delete-presences-text" class="text-lg text-gray-200"></p><div class="flex gap-4"><button id="confirm-delete-presences-button" class="w-full py-3 font-bold bg-red-600 rounded-lg hover:bg-red-700">SIM, EXCLUIR TUDO</button><button id="cancel-delete-presences-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg hover:bg-gray-500">CANCELAR</button></div></div></div>
    <div id="edit-user-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600"><h2 id="edit-user-title" class="text-3xl font-brand text-amber-400">Editar Jogador</h2><form id="edit-user-form" class="space-y-4"><div><label for="edit-password" class="text-xl text-gray-300">Nova Senha (deixe em branco)</label><input type="password" id="edit-password" name="edit-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white"></div><div><label for="edit-user-role" class="text-xl text-gray-300">Perfil</label><select id="edit-user-role" name="edit-user-role" class="mt-2 w-full px-4 py-3 bg-gray-700 rounded-lg text-white"><option value="padrão">Padrão</option><option value="administrador">Administrador</option></select></div><div class="flex gap-4 pt-4"><button type="submit" class="w-full py-3 font-bold bg-blue-600 hover:bg-blue-700 rounded-lg">GUARDAR</button><button type="button" id="cancel-edit-user-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CANCELAR</button></div></form></div></div>
    <div id="change-password-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600"><h2 class="text-3xl font-brand text-amber-400 text-center">Alterar Senha</h2><form id="change-password-form" class="space-y-4"><div><label for="current-password" class="text-xl text-gray-300">Senha Atual</label><input type="password" id="current-password" name="current-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required></div><div><label for="new-user-password" class="text-xl text-gray-300">Nova Senha</label><input type="password" id="new-user-password" name="new-user-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required></div><div><label for="confirm-new-password" class="text-xl text-gray-300">Confirmar Nova Senha</label><input type="password" id="confirm-new-password" name="confirm-new-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required></div><div class="flex gap-4 pt-4"><button type="submit" class="w-full py-3 font-bold bg-amber-400 text-gray-900 hover:bg-amber-500 rounded-lg">GUARDAR ALTERAÇÕES</button><button type="button" id="cancel-change-password-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CANCELAR</button></div></form></div></div>
    <div id="guest-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600"><h2 class="text-3xl font-brand text-sky-400 text-center">Adicionar Convidado</h2><form id="guest-form" class="space-y-4"><div><label for="guest-name" class="text-xl text-gray-300">Nome do Convidado</label><input type="text" id="guest-name" name="guest-name" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required></div><div class="flex gap-4 pt-4"><button type="submit" class="w-full py-3 font-bold bg-sky-500 hover:bg-sky-600 rounded-lg">CONFIRMAR CONVIDADO</button><button type="button" id="cancel-guest-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CANCELAR</button></div></form></div></div>

    <!-- MODAIS DE RELATÓRIO ADICIONADOS -->
    <div id="report-date-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600">
            <h2 class="text-3xl font-brand text-green-400 text-center">Gerar Relatório de Presença</h2>
            <form id="report-date-form" class="space-y-4">
                <div>
                    <label for="start-date" class="text-xl text-gray-300">Data de Início</label>
                    <input type="date" id="start-date" name="start-date" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                </div>
                 <div>
                    <label for="end-date" class="text-xl text-gray-300">Data Final</label>
                    <input type="date" id="end-date" name="end-date" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="w-full py-3 font-bold bg-green-600 hover:bg-green-700 rounded-lg">GERAR</button>
                    <button type="button" id="cancel-report-date-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CANCELAR</button>
                </div>
            </form>
        </div>
    </div>
    <div id="report-display-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
         <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-2xl space-y-4 border border-gray-600">
            <h2 class="text-3xl font-brand text-green-400 text-center">Relatório de Presença</h2>
            <pre id="report-content" class="bg-gray-900 text-white p-4 rounded-lg h-96 overflow-y-auto text-sm whitespace-pre-wrap"></pre>
            <div class="flex gap-4 pt-4">
                <button id="download-report-button" class="w-full py-3 font-bold bg-blue-600 hover:bg-blue-700 rounded-lg">BAIXAR RELATÓRIO</button>
                <button id="close-report-display-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">FECHAR</button>
            </div>
        </div>
    </div>


    <!-- SCRIPTS DO FIREBASE -->
    <script type="module">
        // Importa as funções que precisamos do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, setDoc, deleteDoc, query, where, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE (IMPORTANTE!) ---
        const firebaseConfig = {
          apiKey: "AIzaSyBRJIBPTlphfKMhGJEz6IGQXAnkuGyY3Po",
          authDomain: "voleidavila-690c6.firebaseapp.com",
          projectId: "voleidavila-690c6",
          storageBucket: "voleidavila-690c6.appspot.com",
          messagingSenderId: "162439328929",
          appId: "1:162439328929:web:5aa41c21408234ca51ace0"
        };

        // Inicializa o Firebase e o Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTES E VARIÁVEIS GLOBAIS ---
            const TOTAL_SLOTS = 24;
            
            // --- ELEMENTOS DA UI ---
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logout-button');
            const welcomeMessage = document.getElementById('welcome-message');
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const adminTabButton = document.getElementById('admin-tab-button');
            const registrationForm = document.getElementById('registration-form');
            const userList = document.getElementById('user-list');
            const presenceModal = document.getElementById('presence-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalConfirmText = document.getElementById('modal-confirm-text');
            const confirmBtn = document.getElementById('confirm-presence-button');
            const cancelBtn = document.getElementById('cancel-presence-button');
            const messageModal = document.getElementById('message-modal');
            const messageTitle = document.getElementById('message-title');
            const messageText = document.getElementById('message-text');
            const messageOkButton = document.getElementById('message-ok-button');
            const unconfirmModal = document.getElementById('unconfirm-modal');
            const unconfirmModalText = document.getElementById('unconfirm-modal-text');
            const confirmUnmarkBtn = document.getElementById('confirm-unmark-button');
            const cancelUnmarkBtn = document.getElementById('cancel-unmark-button');
            const adminActionModal = document.getElementById('admin-action-modal');
            const adminActionTitle = document.getElementById('admin-action-title');
            const adminActionText = document.getElementById('admin-action-text');
            const adminActionRemoveBtn = document.getElementById('admin-action-remove-button');
            const adminActionPenaltyBtn = document.getElementById('admin-action-penalty-button');
            const adminActionCancelBtn = document.getElementById('admin-action-cancel-button');
            const penaltyModal = document.getElementById('penalty-modal');
            const penaltyText = document.getElementById('penalty-text');
            const penaltyCancelBtn = document.getElementById('penalty-cancel-button');
            const deleteUserModal = document.getElementById('delete-user-modal');
            const deleteUserText = document.getElementById('delete-user-text');
            const confirmDeleteUserBtn = document.getElementById('confirm-delete-user-button');
            const cancelDeleteUserBtn = document.getElementById('cancel-delete-user-button');
            const deletePresencesModal = document.getElementById('delete-presences-modal');
            const deletePresencesText = document.getElementById('delete-presences-text');
            const confirmDeletePresencesBtn = document.getElementById('confirm-delete-presences-button');
            const cancelDeletePresencesBtn = document.getElementById('cancel-delete-presences-button');
            const editUserModal = document.getElementById('edit-user-modal');
            const editUserTitle = document.getElementById('edit-user-title');
            const editUserForm = document.getElementById('edit-user-form');
            const cancelEditUserBtn = document.getElementById('cancel-edit-user-button');
            const adminDateSelector = document.getElementById('admin-date-selector');
            const adminControls = document.getElementById('admin-controls');
            const pauseDateButton = document.getElementById('pause-date-button');
            const deletePresencesButton = document.getElementById('delete-presences-button');
            const playerDateDisplay = document.getElementById('player-date-display');
            const presenceDateInput = document.getElementById('presence-date');
            const presenceListContainer = document.getElementById('presence-list-container');
            const selectedDateTitle = document.getElementById('selected-date-title');
            const presenceSlots = document.getElementById('presence-slots');
            const changePasswordButton = document.getElementById('change-password-button');
            const changePasswordModal = document.getElementById('change-password-modal');
            const changePasswordForm = document.getElementById('change-password-form');
            const cancelChangePasswordButton = document.getElementById('cancel-change-password-button');
            const guestControls = document.getElementById('guest-controls');
            const addGuestButton = document.getElementById('add-guest-button');
            const guestModal = document.getElementById('guest-modal');
            const guestForm = document.getElementById('guest-form');
            const cancelGuestButton = document.getElementById('cancel-guest-button');
            // Elementos de Relatório
            const generateReportButton = document.getElementById('generate-report-button');
            const reportDateModal = document.getElementById('report-date-modal');
            const reportDateForm = document.getElementById('report-date-form');
            const cancelReportDateButton = document.getElementById('cancel-report-date-button');
            const reportDisplayModal = document.getElementById('report-display-modal');
            const reportContent = document.getElementById('report-content');
            const downloadReportButton = document.getElementById('download-report-button');
            const closeReportDisplayButton = document.getElementById('close-report-display-button');

            let currentSlotData = null; 
            let selectedPlayerForAction = null;
            let userToEditId = null;
            let userToDeleteId = null;

            // --- FUNÇÕES GERAIS ---
            function showMessage(title, text) {
                messageTitle.textContent = title;
                messageText.textContent = text;
                messageModal.classList.add('flex');
            }
            
            function updatePresenceViewForRole(role, activeDate, isPaused) {
                playerDateDisplay.classList.add('hidden');
                adminDateSelector.classList.add('hidden');
                presenceListContainer.classList.add('hidden');
                
                if (role === 'administrador') {
                    adminDateSelector.classList.add('flex');
                    adminDateSelector.classList.remove('hidden');
                    presenceDateInput.value = activeDate || '';
                    if (activeDate) {
                        adminControls.classList.remove('hidden');
                        pauseDateButton.textContent = isPaused ? 'Retomar Marcações' : 'Pausar Marcações';
                        renderSlotsForDate(activeDate, isPaused);
                    } else {
                        adminControls.classList.add('hidden');
                    }
                } else {
                    playerDateDisplay.classList.remove('hidden');
                    if (activeDate) {
                        const dateObj = new Date(activeDate + 'T00:00:00');
                        const formattedDate = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
                        let statusText = isPaused ? '<span class="font-bold text-yellow-500">(Marcações Pausadas)</span>' : '';
                        playerDateDisplay.innerHTML = `<p class="text-2xl">Data ativa: <span class="font-bold text-amber-400">${formattedDate}</span> ${statusText}</p>`;
                        renderSlotsForDate(activeDate, isPaused);
                    } else {
                        playerDateDisplay.innerHTML = `<p class="text-2xl text-red-500 font-bold">A aguardar a libertação da data.</p>`;
                    }
                }
            }
            
            async function refreshUI() {
                try {
                    const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                    const settings = configDoc.exists() ? configDoc.data() : { data_ativa: null, marcacoes_pausadas: false };
                    
                    const userRole = sessionStorage.getItem('userRole');
                    if (userRole) {
                        updatePresenceViewForRole(userRole, settings.data_ativa, settings.marcacoes_pausadas);
                    }
                    if(userRole === 'administrador') {
                        renderUserList();
                    }
                } catch (error) {
                    console.error("Erro ao atualizar a UI: ", error);
                    showMessage("Erro de Conexão", "Não foi possível carregar os dados. Verifique a sua ligação à internet e as configurações do Firebase.");
                }
            }
            
            // --- LÓGICA DE GESTÃO DE UTILIZADORES ---
            async function renderUserList() {
                userList.innerHTML = '<p class="text-center">A carregar jogadores...</p>';
                try {
                    const q = query(collection(db, "jogadores"));
                    const querySnapshot = await getDocs(q);
                    userList.innerHTML = '';
                    
                    const users = [];
                    querySnapshot.forEach((doc) => {
                        users.push({ id: doc.id, ...doc.data() });
                    });

                    users.sort((a, b) => a.nome_exibicao.localeCompare(b.nome_exibicao)).forEach(user => {
                        const penaltyInfo = user.penalidade_ate ? `<p class="text-xs text-red-400">Penalizado até ${new Date(user.penalidade_ate + 'T00:00:00').toLocaleDateString('pt-BR')}</p>` : '';
                        const removePenaltyButton = user.penalidade_ate ? `<button data-userid="${user.id}" class="remove-penalty-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm">Remover Penalidade</button>` : '';
                        
                        const userEl = document.createElement('div');
                        userEl.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                        userEl.innerHTML = `
                            <div>
                                <p class="font-bold text-white text-lg">${user.nome_exibicao}</p>
                                <p class="text-sm text-amber-400 capitalize">${user.perfil}</p>
                                ${penaltyInfo}
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 items-end">
                                ${removePenaltyButton}
                                <button data-userid="${user.id}" data-username="${user.nome_exibicao}" data-userrole="${user.perfil}" class="edit-user-btn bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded text-sm">Editar</button>
                                <button data-userid="${user.id}" data-username="${user.nome_exibicao}" class="delete-user-btn bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded text-sm">Excluir</button>
                            </div>
                        `;
                        userList.appendChild(userEl);
                        if (user.nome_exibicao === sessionStorage.getItem('loggedInUser')) {
                            userEl.querySelector('.edit-user-btn').disabled = true;
                            userEl.querySelector('.delete-user-btn').disabled = true;
                            userEl.querySelector('.edit-user-btn').classList.add('opacity-50', 'cursor-not-allowed');
                            userEl.querySelector('.delete-user-btn').classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    });
                } catch (error) {
                    console.error("Erro ao renderizar a lista de utilizadores: ", error);
                    userList.innerHTML = '<p class="text-center text-red-500">Falha ao carregar jogadores.</p>';
                }
            }
            
            async function handleSaveUserChanges(e) {
                e.preventDefault();
                const newPassword = editUserForm['edit-password'].value;
                const newRole = editUserForm['edit-user-role'].value;
                
                try {
                    const userRef = doc(db, "jogadores", userToEditId);
                    const updateData = { perfil: newRole };
                    if (newPassword) updateData.senha = newPassword;
                    
                    await updateDoc(userRef, updateData);
                    
                    showMessage('Sucesso', 'Dados do jogador atualizados.');
                    editUserModal.classList.remove('flex');
                    userToEditId = null;
                    renderUserList();
                } catch (error) {
                    console.error("Erro ao guardar alterações do utilizador: ", error);
                    showMessage("Erro", "Não foi possível guardar as alterações.");
                }
            }
            
            async function handleChangePassword(e) {
                e.preventDefault();
                const currentPassword = changePasswordForm['current-password'].value;
                const newPassword = changePasswordForm['new-user-password'].value;
                const confirmPassword = changePasswordForm['confirm-new-password'].value;

                if (newPassword !== confirmPassword) {
                    showMessage("Erro", "As novas senhas não coincidem.");
                    return;
                }

                if (newPassword.length < 4) {
                    showMessage("Erro", "A nova senha deve ter pelo menos 4 caracteres.");
                    return;
                }

                const userId = sessionStorage.getItem('loggedInUserId');
                if (!userId) {
                    showMessage("Erro", "Sessão inválida. Por favor, faça o login novamente.");
                    return;
                }

                try {
                    const userRef = doc(db, "jogadores", userId);
                    const userDoc = await getDoc(userRef);

                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.senha !== currentPassword) {
                            showMessage("Erro", "A senha atual está incorreta.");
                            return;
                        }

                        await updateDoc(userRef, { senha: newPassword });
                        showMessage("Sucesso", "Senha alterada com sucesso!");
                        changePasswordModal.classList.remove('flex');
                        changePasswordForm.reset();

                    } else {
                        showMessage("Erro", "Utilizador não encontrado.");
                    }
                } catch (error) {
                    console.error("Erro ao alterar a senha: ", error);
                    showMessage("Erro", "Não foi possível alterar a sua senha. Tente novamente.");
                }
            }
            
            async function handleConfirmDeleteUser() {
                try {
                    await deleteDoc(doc(db, "jogadores", userToDeleteId));
                    showMessage('Sucesso', 'Jogador excluído do sistema.');
                    deleteUserModal.classList.remove('flex');
                    userToDeleteId = null;
                    renderUserList();
                } catch (error) {
                    console.error("Erro ao excluir utilizador: ", error);
                    showMessage("Erro", "Não foi possível excluir o jogador.");
                }
            }

            async function handleRemovePenalty(userId) {
                try {
                    const userRef = doc(db, "jogadores", userId);
                    await updateDoc(userRef, { penalidade_ate: null });
                    showMessage('Sucesso', 'A penalidade do jogador foi removida.');
                    renderUserList();
                } catch (error) {
                    console.error("Erro ao remover penalidade: ", error);
                    showMessage("Erro", "Não foi possível remover a penalidade.");
                }
            }
            
            // --- LÓGICA DE PRESENÇA, CONVIDADO E PENALIDADE ---
            async function renderSlotsForDate(dateString, isPaused) {
                presenceListContainer.classList.remove('hidden');
                const dateObj = new Date(dateString + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
                selectedDateTitle.textContent = `Presença para ${formattedDate}`;

                presenceSlots.innerHTML = '<p class="col-span-full text-center">A carregar presenças...</p>';
                const loggedInUserId = sessionStorage.getItem('loggedInUserId');
                const userRole = sessionStorage.getItem('userRole');
                
                try {
                    const playersSnapshot = await getDocs(collection(db, "jogadores"));
                    const playersMap = new Map();
                    playersSnapshot.forEach(doc => {
                        playersMap.set(doc.id, doc.data().nome_exibicao);
                    });

                    const q = query(collection(db, "presencas"), where("data_jogo", "==", dateString));
                    const presenceSnapshot = await getDocs(q);

                    const presences = {};
                    presenceSnapshot.forEach(doc => {
                        const data = doc.data();
                        const playerName = data.tipo === 'convidado' ? data.nome_convidado : playersMap.get(data.jogador_id);
                        if (playerName) {
                            presences[data.numero_vaga] = {
                                playerName: playerName,
                                playerId: data.jogador_id,
                                docId: doc.id,
                                type: data.tipo || 'jogador'
                            };
                        }
                    });
                    
                    presenceSlots.innerHTML = '';
                    if(userRole === 'administrador' && !isPaused) {
                        presenceSlots.classList.add('admin-view');
                    } else {
                        presenceSlots.classList.remove('admin-view');
                    }

                    let userHasPresence = false;
                    for (let i = 0; i < TOTAL_SLOTS; i++) {
                        const presenceData = presences[i];
                        const slotEl = document.createElement('div');
                        slotEl.dataset.slot = i;
                        slotEl.className = 'slot p-3 rounded-lg text-center font-bold truncate';

                        if (isPaused) {
                            slotEl.classList.add('slot-paused');
                            slotEl.textContent = presenceData ? presenceData.playerName : `#${i + 1}`;
                        } else {
                            if (presenceData) {
                                slotEl.textContent = presenceData.playerName;
                                slotEl.dataset.docId = presenceData.docId;
                                slotEl.dataset.playerName = presenceData.playerName;
                                slotEl.dataset.playerId = presenceData.playerId;
                                slotEl.dataset.type = presenceData.type;
                                
                                if (presenceData.playerId === loggedInUserId) {
                                    if (presenceData.type === 'convidado') {
                                        slotEl.classList.add('slot-guest-mine');
                                    } else {
                                        slotEl.classList.add('slot-mine');
                                        userHasPresence = true;
                                    }
                                } else {
                                     if (presenceData.type === 'convidado') {
                                        slotEl.classList.add('slot-guest');
                                    } else {
                                        slotEl.classList.add('slot-taken');
                                    }
                                }
                            } else {
                                slotEl.textContent = `#${i + 1}`;
                                slotEl.classList.add('slot-free');
                            }
                            slotEl.addEventListener('click', handleSlotClick);
                        }
                        presenceSlots.appendChild(slotEl);
                    }
                    guestControls.classList.toggle('hidden', !userHasPresence || isPaused);

                } catch (error) {
                    console.error("Erro ao renderizar vagas: ", error);
                    presenceSlots.innerHTML = '<p class="col-span-full text-center text-red-500">Falha ao carregar presenças.</p>';
                }
            }

            async function handleSlotClick(event) {
                try {
                    const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                    if (configDoc.exists() && configDoc.data().marcacoes_pausadas) return;

                    const target = event.target.closest('.slot');
                    if (!target) return;

                    const slot = target.dataset.slot;
                    const docId = target.dataset.docId;
                    const playerName = target.dataset.playerName;
                    const playerId = target.dataset.playerId;
                    const type = target.dataset.type;
                    const userRole = sessionStorage.getItem('userRole');
                    const loggedInUserId = sessionStorage.getItem('loggedInUserId');

                    currentSlotData = { slot, docId, playerName, playerId, type };

                    if (target.classList.contains('slot-free')) { 
                        const loggedInUser = sessionStorage.getItem('loggedInUser');
                        modalTitle.textContent = `Confirmar Vaga #${parseInt(slot) + 1}`;
                        modalConfirmText.textContent = `Confirma a presença para ${loggedInUser}?`;
                        presenceModal.classList.add('flex');
                    } else if (target.classList.contains('slot-mine') || target.classList.contains('slot-guest-mine')) {
                         unconfirmModalText.textContent = `Tem a certeza de que deseja remover a presença de ${playerName}?`;
                         unconfirmModal.classList.add('flex');
                    } else if (userRole === 'administrador') {
                        selectedPlayerForAction = { name: playerName, id: playerId, type: type };
                        adminActionText.textContent = `Escolha uma ação para ${playerName}:`;
                        adminActionModal.classList.add('flex');
                    }
                } catch (error) {
                    console.error("ERRO CRÍTICO AO CLICAR NA VAGA:", error);
                }
            }
            
            async function handleGuestSubmit(e) {
                e.preventDefault();
                const guestName = guestForm['guest-name'].value.trim();
                if (!guestName) {
                    showMessage("Erro", "Por favor, insira o nome do convidado.");
                    return;
                }

                const firstFreeSlot = document.querySelector('.slot-free');
                if (!firstFreeSlot) {
                    showMessage("Erro", "Não há mais vagas disponíveis.");
                    guestModal.classList.remove('flex');
                    return;
                }

                const slotNumber = parseInt(firstFreeSlot.dataset.slot);
                const loggedInUserId = sessionStorage.getItem('loggedInUserId');

                try {
                    const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                    const activeDate = configDoc.data().data_ativa;

                    await addDoc(collection(db, "presencas"), {
                        data_jogo: activeDate,
                        jogador_id: loggedInUserId,
                        numero_vaga: slotNumber,
                        tipo: 'convidado',
                        nome_convidado: guestName
                    });
                    
                    guestModal.classList.remove('flex');
                    guestForm.reset();
                    refreshUI();

                } catch(error) {
                    console.error("Erro ao adicionar convidado:", error);
                    showMessage("Erro", "Não foi possível adicionar o convidado.");
                }
            }

            async function handleConfirmPresence() {
                const loggedInUserId = sessionStorage.getItem('loggedInUserId');
                if (!loggedInUserId) {
                    showMessage('Erro', 'Utilizador não encontrado. Por favor, faça login novamente.');
                    presenceModal.classList.remove('flex');
                    return;
                }
                
                try {
                    const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                    if (!configDoc.exists() || !configDoc.data().data_ativa) {
                        showMessage('Erro', 'Nenhuma data ativa para marcação. Fale com um administrador.');
                        presenceModal.classList.remove('flex');
                        return;
                    }
                    const activeDate = configDoc.data().data_ativa;

                    const qUser = query(collection(db, "presencas"), where("data_jogo", "==", activeDate), where("jogador_id", "==", loggedInUserId), where("tipo", "==", "jogador"));
                    const userSnapshot = await getDocs(qUser);

                    if (!userSnapshot.empty) {
                        showMessage('Já Confirmado', `Já tem presença confirmada para esta data.`);
                    } else {
                        await addDoc(collection(db, "presencas"), {
                            data_jogo: activeDate,
                            jogador_id: loggedInUserId,
                            numero_vaga: parseInt(currentSlotData.slot),
                            tipo: 'jogador'
                        });
                    }
                     presenceModal.classList.remove('flex');
                     refreshUI();
                } catch (error) {
                    console.error("ERRO CRÍTICO AO CONFIRMAR PRESENÇA:", error);
                    showMessage("Erro", "Não foi possível marcar a presença.");
                }
            }
            
            async function handleConfirmUnmark() {
                if (!currentSlotData || !currentSlotData.docId) return;

                try {
                    await deleteDoc(doc(db, "presencas", currentSlotData.docId));
                    unconfirmModal.classList.remove('flex');
                    adminActionModal.classList.remove('flex');
                    refreshUI();
                } catch (error) {
                    showMessage("Erro", "Não foi possível remover a presença.");
                }
            }
            
            async function handlePenalty(days) {
                if (selectedPlayerForAction.type === 'convidado') {
                    showMessage('Aviso', 'A penalidade só pode ser aplicada a jogadores registados. Remova a presença se necessário.');
                     penaltyModal.classList.remove('flex');
                    return;
                }
                try {
                    const today = new Date();
                    today.setDate(today.getDate() + days);
                    const penaltyEndDate = today.toISOString().split('T')[0];

                    const userRef = doc(db, "jogadores", selectedPlayerForAction.id);
                    await updateDoc(userRef, { penalidade_ate: penaltyEndDate });
                    
                    await handleConfirmUnmark(); 

                    showMessage('Sucesso', `${selectedPlayerForAction.name} foi penalizado e removido da lista.`);
                    penaltyModal.classList.remove('flex');
                    renderUserList();
                } catch (error) {
                    console.error("Erro ao aplicar penalidade: ", error);
                    showMessage("Erro", "Não foi possível aplicar a penalidade.");
                }
            }
            
            // --- LÓGICA DE RELATÓRIO ---
            async function handleGenerateReport(e) {
                e.preventDefault();
                const startDate = reportDateForm['start-date'].value;
                const endDate = reportDateForm['end-date'].value;

                if (!startDate || !endDate || startDate > endDate) {
                    showMessage('Erro de Validação', 'Por favor, selecione um intervalo de datas válido.');
                    return;
                }

                reportContent.textContent = 'A gerar relatório...';
                reportDateModal.classList.remove('flex');
                reportDisplayModal.classList.add('flex');

                try {
                    const playersSnapshot = await getDocs(collection(db, "jogadores"));
                    const playersMap = new Map();
                    const presenceCounts = {};
                    playersSnapshot.forEach(doc => {
                        const playerData = doc.data();
                        playersMap.set(doc.id, playerData.nome_exibicao);
                        presenceCounts[playerData.nome_exibicao] = 0;
                    });

                    const guestCounts = {};

                    const q = query(collection(db, "presencas"), where("data_jogo", ">=", startDate), where("data_jogo", "<=", endDate));
                    const presenceSnapshot = await getDocs(q);

                    presenceSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.tipo === 'jogador') {
                            const playerName = playersMap.get(data.jogador_id);
                            if (playerName) presenceCounts[playerName]++;
                        } else if (data.tipo === 'convidado') {
                            const hostName = playersMap.get(data.jogador_id);
                            const guestKey = `${data.nome_convidado} (convidado por ${hostName || 'Desconhecido'})`;
                            guestCounts[guestKey] = (guestCounts[guestKey] || 0) + 1;
                        }
                    });

                    const sortedPlayers = Object.entries(presenceCounts).sort(([,a],[,b]) => b-a);
                    const sortedGuests = Object.entries(guestCounts).sort(([,a],[,b]) => b-a);

                    const formattedStartDate = new Date(startDate + 'T00:00:00').toLocaleDateString('pt-BR');
                    const formattedEndDate = new Date(endDate + 'T00:00:00').toLocaleDateString('pt-BR');
                    
                    let reportString = `Relatório de Presença - ${formattedStartDate} a ${formattedEndDate}\n`;
                    reportString += '============================================\n\n';
                    reportString += '--- JOGADORES ---\n';
                    sortedPlayers.forEach(([name, count]) => {
                        reportString += `${name}: ${count} presença(s)\n`;
                    });

                    if (sortedGuests.length > 0) {
                        reportString += '\n--- CONVIDADOS ---\n';
                        sortedGuests.forEach(([name, count]) => {
                            reportString += `${name}: ${count} presença(s)\n`;
                        });
                    }

                    reportContent.textContent = reportString;

                } catch (error) {
                    console.error("Erro ao gerar relatório: ", error);
                    reportContent.textContent = 'Ocorreu um erro ao gerar o relatório.';
                }
            }

            function handleDownloadReport() {
                const text = reportContent.textContent;
                const startDate = reportDateForm['start-date'].value;
                const endDate = reportDateForm['end-date'].value;
                const filename = `relatorio_presenca_${startDate}_a_${endDate}.txt`;

                const blob = new Blob([text], { type: 'text/plain' });
                const anchor = document.createElement('a');
                
                anchor.href = URL.createObjectURL(blob);
                anchor.download = filename;
                
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);

                URL.revokeObjectURL(anchor.href);
            }

            // --- LÓGICA DE NAVEGAÇÃO E AUTENTICAÇÃO ---
            function handleTabClick(event) {
                tabs.forEach(tab => tab.classList.remove('active'));
                event.currentTarget.classList.add('active');
                const tabId = event.currentTarget.dataset.tab;
                tabContents.forEach(content => {
                    content.id === tabId ? content.classList.remove('hidden') : content.classList.add('hidden');
                });
            }
            
            async function handleLogin(event) {
                event.preventDefault();
                const loginErrorEl = document.getElementById('login-error');
                loginErrorEl.classList.add('hidden');
                
                const usernameInput = loginForm.username.value;
                const password = loginForm.password.value;
                const normalizedUsername = usernameInput.toLowerCase().replace(/\s+/g, '');
                
                try {
                    const q = query(collection(db, "jogadores"), where("nome_usuario", "==", normalizedUsername), where("senha", "==", password));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        loginErrorEl.textContent = 'Utilizador ou senha inválidos.';
                        loginErrorEl.classList.remove('hidden');
                    } else {
                        const userDoc = querySnapshot.docs[0];
                        const userData = userDoc.data();
                        
                        if (userData.penalidade_ate) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const penaltyDate = new Date(userData.penalidade_ate + 'T00:00:00');
                            
                            if (today <= penaltyDate) {
                                const formattedDate = penaltyDate.toLocaleDateString('pt-BR');
                                loginErrorEl.textContent = `Está penalizado até ${formattedDate}.`;
                                loginErrorEl.classList.remove('hidden');
                                return;
                            }
                        }

                        sessionStorage.setItem('loggedInUserId', userDoc.id);
                        sessionStorage.setItem('loggedInUser', userData.nome_exibicao);
                        sessionStorage.setItem('userRole', userData.perfil);
                        
                        showApp(userData.nome_exibicao, userData.perfil);
                        refreshUI();
                    }
                } catch (error) {
                    console.error("ERRO CRÍTICO DURANTE O LOGIN:", error);
                    loginErrorEl.textContent = 'Erro de conexão. Tente novamente.';
                    loginErrorEl.classList.remove('hidden');
                }
            }

            function handleLogout() {
                sessionStorage.clear();
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                adminTabButton.classList.add('hidden');
                loginForm.reset();
                document.querySelector('.tab-button[data-tab="presenca"]').click();
            }
            
            async function handleRegistration(event) {
                event.preventDefault();
                const registrationMessage = document.getElementById('registration-message');
                const newUsername = registrationForm['new-username'].value;
                const newPassword = registrationForm['new-password'].value;
                const role = registrationForm['user-role'].value;

                if (!newUsername || !newPassword) {
                    registrationMessage.textContent = "Preencha todos os campos.";
                    registrationMessage.className = "text-center text-lg text-red-500";
                    return;
                }

                const normalizedUsername = newUsername.toLowerCase().replace(/\s+/g, '');
                
                try {
                    const q = query(collection(db, "jogadores"), where("nome_usuario", "==", normalizedUsername));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        registrationMessage.textContent = "Este jogador já existe.";
                        registrationMessage.className = "text-center text-lg text-red-500";
                    } else {
                        await addDoc(collection(db, "jogadores"), {
                            nome_exibicao: newUsername,
                            nome_usuario: normalizedUsername,
                            senha: newPassword,
                            perfil: role,
                            penalidade_ate: null
                        });
                        registrationMessage.textContent = "Jogador cadastrado!";
                        registrationMessage.className = "text-center text-lg text-green-500";
                        registrationForm.reset();
                        setTimeout(() => registrationMessage.textContent = '', 3000);
                        renderUserList();
                    }
                } catch (error) {
                    console.error("Erro no registo: ", error);
                    registrationMessage.textContent = "Erro ao cadastrar. Tente novamente.";
                    registrationMessage.className = "text-center text-lg text-red-500";
                }
            }
            
            function showApp(username, role) {
                welcomeMessage.textContent = `Bem-vindo(a), ${username}!`;
                if (role === 'administrador') {
                    adminTabButton.classList.remove('hidden');
                } else {
                    adminTabButton.classList.add('hidden');
                }
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                loginForm.reset();
            }

            // --- INICIALIZAÇÃO E EVENT LISTENERS ---
            function main() {
                const loggedInUser = sessionStorage.getItem('loggedInUser');
                const userRole = sessionStorage.getItem('userRole');
                if(loggedInUser && userRole) {
                    showApp(loggedInUser, userRole);
                    refreshUI();
                }
                
                loginForm.addEventListener('submit', handleLogin);
                logoutButton.addEventListener('click', handleLogout);
                tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
                registrationForm.addEventListener('submit', handleRegistration);
                editUserForm.addEventListener('submit', handleSaveUserChanges);
                confirmDeleteUserBtn.addEventListener('click', handleConfirmDeleteUser);
                messageOkButton.addEventListener('click', () => messageModal.classList.remove('flex'));
                
                changePasswordButton.addEventListener('click', () => {
                    changePasswordForm.reset();
                    changePasswordModal.classList.add('flex');
                });
                cancelChangePasswordButton.addEventListener('click', () => changePasswordModal.classList.remove('flex'));
                changePasswordForm.addEventListener('submit', handleChangePassword);
                
                addGuestButton.addEventListener('click', () => guestModal.classList.add('flex'));
                cancelGuestButton.addEventListener('click', () => guestModal.classList.remove('flex'));
                guestForm.addEventListener('submit', handleGuestSubmit);

                cancelBtn.addEventListener('click', () => presenceModal.classList.remove('flex'));
                confirmBtn.addEventListener('click', handleConfirmPresence);
                cancelUnmarkBtn.addEventListener('click', () => unconfirmModal.classList.remove('flex'));
                confirmUnmarkBtn.addEventListener('click', handleConfirmUnmark);
                
                adminActionCancelBtn.addEventListener('click', () => adminActionModal.classList.remove('flex'));
                adminActionRemoveBtn.addEventListener('click', () => {
                    adminActionModal.classList.remove('flex');
                    handleConfirmUnmark();
                });
                adminActionPenaltyBtn.addEventListener('click', () => {
                    adminActionModal.classList.remove('flex');
                     if(selectedPlayerForAction.type === 'convidado') {
                         showMessage('Aviso', 'Não é possível aplicar penalidade a um convidado.');
                         return;
                     }
                    penaltyText.textContent = `Escolha a duração da penalidade para ${selectedPlayerForAction.name}.`;
                    penaltyModal.classList.add('flex');
                });
                penaltyCancelBtn.addEventListener('click', () => penaltyModal.classList.remove('flex'));
                document.querySelectorAll('.penalty-duration-button').forEach(button => {
                    button.addEventListener('click', (e) => handlePenalty(parseInt(e.target.dataset.penalty)));
                });
                userList.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.classList.contains('edit-user-btn')) {
                        userToEditId = target.dataset.userid;
                        editUserTitle.textContent = `Editar ${target.dataset.username}`;
                        editUserForm['edit-user-role'].value = target.dataset.userrole;
                        editUserForm['edit-password'].value = '';
                        editUserModal.classList.add('flex');
                    }
                    if (target.classList.contains('delete-user-btn')) {
                        userToDeleteId = target.dataset.userid;
                        deleteUserText.textContent = `Tem a certeza de que quer excluir ${target.dataset.username}? Esta ação não pode ser desfeita.`;
                        deleteUserModal.classList.add('flex');
                    }
                    if (target.classList.contains('remove-penalty-btn')) {
                        handleRemovePenalty(target.dataset.userid);
                    }
                });
                cancelEditUserBtn.addEventListener('click', () => editUserModal.classList.remove('flex'));
                cancelDeleteUserBtn.addEventListener('click', () => deleteUserModal.classList.remove('flex'));

                presenceDateInput.addEventListener('change', async (e) => {
                    const newDate = e.target.value;
                    try {
                        await setDoc(doc(db, "configuracoes", "global"), { data_ativa: newDate, marcacoes_pausadas: false }, { merge: true });
                        refreshUI();
                    } catch (error) { console.error("Erro ao definir data ativa: ", error); }
                });
                
                pauseDateButton.addEventListener('click', async () => {
                    try {
                        const configRef = doc(db, "configuracoes", "global");
                        const configDoc = await getDoc(configRef);
                        const currentStatus = configDoc.exists() ? configDoc.data().marcacoes_pausadas : false;
                        await setDoc(configRef, { marcacoes_pausadas: !currentStatus }, { merge: true });
                        refreshUI();
                    } catch (error) { console.error("Erro ao pausar/retomar marcações: ", error); }
                });

                deletePresencesButton.addEventListener('click', async () => {
                    try {
                        const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                        if (!configDoc.exists() || !configDoc.data().data_ativa) {
                            showMessage('Aviso', 'Nenhuma data ativa selecionada.');
                            return;
                        }
                        const activeDate = configDoc.data().data_ativa;
                        const dateObj = new Date(activeDate + 'T00:00:00');
                        const formattedDate = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long' });
                        deletePresencesText.textContent = `Tem a certeza de que quer apagar TODAS as presenças do dia ${formattedDate}?`;
                        deletePresencesModal.classList.add('flex');
                    } catch(error) { console.error("Erro ao preparar exclusão de presenças: ", error); }
                });
                
                cancelDeletePresencesBtn.addEventListener('click', () => deletePresencesModal.classList.remove('flex'));
                
                confirmDeletePresencesBtn.addEventListener('click', async () => {
                    try {
                        const configDocRef = doc(db, "configuracoes", "global");
                        const configDoc = await getDoc(configDocRef);
                        const activeDate = configDoc.data().data_ativa;
                        if (!activeDate) {
                            deletePresencesModal.classList.remove('flex');
                            return;
                        }
                        const q = query(collection(db, "presencas"), where("data_jogo", "==", activeDate));
                        const snapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(d => batch.delete(d.ref));
                        await batch.commit();
                        await setDoc(configDocRef, { data_ativa: null }, { merge: true });
                        showMessage('Sucesso', 'Presenças removidas e data desativada.');
                        deletePresencesModal.classList.remove('flex');
                        refreshUI();
                    } catch(error) {
                        console.error("Erro ao excluir presenças em lote: ", error);
                        showMessage("Erro", "Não foi possível excluir as presenças.");
                    }
                });

                // Listeners de Relatório
                generateReportButton.addEventListener('click', () => reportDateModal.classList.add('flex'));
                cancelReportDateButton.addEventListener('click', () => reportDateModal.classList.remove('flex'));
                reportDateForm.addEventListener('submit', handleGenerateReport);
                downloadReportButton.addEventListener('click', handleDownloadReport);
                closeReportDisplayButton.addEventListener('click', () => reportDisplayModal.classList.remove('flex'));
            }
            
            main();
        });
    </script>
</body>
</html>