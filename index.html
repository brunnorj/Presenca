<!-- ... todo o código HTML e CSS continua o mesmo ... -->
<html lang="pt-BR">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vôlei da Vila com Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300..700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Teko', sans-serif;
        }
        .bg-pattern {
            background-color: #001f3f;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .tab-button.active {
            background-color: #FBBF24;
            color: #001f3f;
            border-bottom: 4px solid #ffffff;
        }
        .slot {
            transition: all 0.3s ease;
            position: relative; /* Necessário para o ícone de observação */
        }
        .slot-free {
            background-color: #22c55e;
            color: white;
            cursor: pointer;
        }
        .slot-free:hover {
            background-color: #16a34a;
            transform: translateY(-2px);
        }
        .slot-taken {
            background-color: #4b5563;
            color: #e5e7eb;
            cursor: pointer; /* Alterado para permitir clique para ver a foto */
        }
        .slot-mine {
            background-color: #FBBF24;
            color: #001f3f;
            border: 2px solid white;
            font-weight: 900;
            cursor: pointer;
        }
        .slot-mine:hover {
            background-color: #F59E0B;
            transform: translateY(-2px);
        }
        /* ESTILO PARA CONVIDADOS */
        .slot-guest, .slot-guest-mine {
            background-color: #38bdf8; /* Azul claro */
            color: #001f3f;
            border: 2px solid white;
        }
        .slot-guest-mine {
            cursor: pointer;
            font-weight: 900;
        }
        .slot-guest-mine:hover {
            background-color: #0ea5e9;
            transform: translateY(-2px);
        }
        /* NOVOS ESTILOS PARA LISTA DE ESPERA */
        .slot-waiting, .slot-waiting-mine {
            background-color: #f97316; /* Laranja */
            color: white;
            border: 2px solid white;
        }
        .slot-waiting-mine {
            cursor: pointer;
            font-weight: 900;
        }
        .slot-waiting-mine:hover {
            background-color: #ea580c;
            transform: translateY(-2px);
        }

        .admin-view .slot-taken:hover,
        .admin-view .slot-mine:hover,
        .admin-view .slot-guest:hover,
        .admin-view .slot-guest-mine:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        /* Adicionado hover para admin na lista de espera */
        .admin-view .slot-waiting:hover {
            background-color: #0891b2; /* Ciano para indicar 'mover' */
            transform: translateY(-2px);
        }

        .slot-paused {
            background-color: #6b7280;
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* ÍCONE DE OBSERVAÇÃO */
        .observation-icon {
            position: absolute;
            top: -6px;
            right: -6px;
            background-color: #ef4444; /* red-500 */
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: transform 0.2s ease;
            z-index: 10;
        }
        .observation-icon:hover {
            transform: scale(1.1);
        }
        .font-brand {
            font-family: 'Teko', sans-serif;
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.flex {
            display: flex;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.5);
            cursor: pointer;
        }
        /* Estilos para a página Legal */
        .legal-content h3 {
            font-size: 1.75rem; /* ~28px */
            font-weight: 700;
            color: #FBBF24; /* amber-400 */
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .legal-content p, .legal-content li {
            font-size: 1.125rem; /* ~18px */
            line-height: 1.6;
            color: #d1d5db; /* gray-300 */
        }
        .legal-content p {
            margin-bottom: 1rem;
        }
        .legal-content ul {
            list-style-type: disc;
            list-style-position: inside;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }

        #image-zoom-modal {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        #image-zoom-modal.flex {
            opacity: 1;
            pointer-events: auto;
        }
        #image-zoom-modal img {
            transform: scale(0.8);
            transition: transform 0.3s ease-in-out;
        }
        #image-zoom-modal.flex img {
            transform: scale(1);
        }
        #close-player-photo-button {
            font-size: 2.5rem;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-pattern text-white min-h-screen">

    <!-- Tela de Login -->
    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-4 relative">
        <div class="w-full max-w-sm p-8 space-y-6 bg-gray-800 bg-opacity-80 rounded-2xl shadow-lg border border-gray-700">
            <div class="text-center">
                 <img src="https://placehold.co/100x100/FBBF24/001f3f?text=VV" alt="Logo Vôlei da Vila" class="mx-auto mb-4 rounded-full border-4 border-amber-400">
                <h1 class="text-5xl font-brand font-bold text-amber-400">VÔLEI DA VILA</h1>
                <p class="text-gray-300">Faça o login para continuar</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="sr-only">Utilizador</label>
                    <input type="text" id="username" name="username" placeholder="Nome de Utilizador" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-400" required>
                </div>
                <div>
                    <label for="password" class="sr-only">Senha</label>
                    <input type="password" id="password" name="password" placeholder="Senha" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-400" required>
                </div>
                <p id="login-error" class="text-red-500 text-center text-sm hidden">Utilizador ou senha inválidos.</p>
                <button type="submit" class="w-full px-4 py-3 font-bold text-lg bg-amber-400 text-gray-900 rounded-lg hover:bg-amber-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-amber-400 transition-colors duration-300">
                    ENTRAR
                </button>
            </form>
        </div>
        <footer class="absolute bottom-4 text-center w-full text-gray-500 text-sm">
            Copyright 2025 Bruno Sampaio
        </footer>
    </div>

    <!-- Conteúdo Principal do Site -->
    <div id="app-screen" class="hidden">
        <header class="bg-gray-900 bg-opacity-70 p-4 shadow-lg sticky top-0 z-20 backdrop-blur-sm">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-4xl font-brand font-bold text-amber-400">VÔLEI DA VILA</h1>
                <div class="flex items-center space-x-4">
                    <span id="welcome-message" class="text-lg text-gray-300"></span>
                    <button id="change-password-button" class="px-4 py-2 text-sm font-bold bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">ALTERAR SENHA</button>
                    <button id="logout-button" class="px-4 py-2 text-sm font-bold bg-red-600 rounded-lg hover:bg-red-700 transition-colors">SAIR</button>
                </div>
            </div>
        </header>
        
        <nav class="bg-gray-800">
            <div class="container mx-auto flex justify-center flex-wrap">
                <button data-tab="presenca" class="tab-button text-2xl font-bold py-4 px-6 active">Presença</button>
                <button data-tab="torneio" class="tab-button text-2xl font-bold py-4 px-6">Torneio</button>
                <button data-tab="informacoes" class="tab-button text-2xl font-bold py-4 px-6">Informações</button>
                <button data-tab="album" class="tab-button text-2xl font-bold py-4 px-6">Álbum</button>
                <button id="admin-tab-button" data-tab="cadastro" class="tab-button text-2xl font-bold py-4 px-6 hidden">Gestão</button>
                <button data-tab="legal" class="tab-button text-2xl font-bold py-4 px-6">Legal</button>
                <button id="log-tab-button" data-tab="log" class="tab-button text-2xl font-bold py-4 px-6 hidden">Log</button>
            </div>
        </nav>

        <main class="container mx-auto p-4 md:p-8">
            <!-- Aba de Presença -->
            <div id="presenca" class="tab-content">
                <div class="text-center mb-8">
                    <h2 class="text-5xl font-brand font-bold text-white">LISTA DE PRESENÇA</h2>
                    <p class="text-xl text-gray-400">Marque a sua presença para o dia ativo.</p>
                    <div id="guest-controls" class="mt-4 hidden">
                        <button id="add-guest-button" class="px-6 py-2 font-bold text-lg bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors">
                            LEVAR CONVIDADO
                        </button>
                    </div>
                </div>

                <div id="admin-date-selector" class="hidden flex-col items-center gap-4 mb-8">
                    <label for="presence-date" class="text-2xl font-bold">Ativar data para marcação:</label>
                    <input type="date" id="presence-date" class="bg-gray-700 border border-gray-600 rounded-lg p-3 text-white text-xl focus:outline-none focus:ring-2 focus:ring-amber-400">
                    <div class="flex items-center gap-4 mt-4">
                        <label class="text-xl font-bold">Definir Vagas:</label>
                        <button id="set-18-slots-button" class="px-4 py-2 font-bold bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors">18 Vagas</button>
                        <button id="set-24-slots-button" class="px-4 py-2 font-bold bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors">24 Vagas</button>
                        <span id="current-slots-display" class="text-lg text-gray-300"></span>
                    </div>
                    <div id="admin-controls" class="flex flex-wrap justify-center gap-4 mt-2">
                        <button id="pause-date-button" class="px-4 py-2 font-bold bg-yellow-600 rounded-lg hover:bg-yellow-700 transition-colors">Pausar Marcações</button>
                        <button id="delete-presences-button" class="px-4 py-2 font-bold bg-red-800 rounded-lg hover:bg-red-900 transition-colors">Excluir Presenças</button>
                        <button id="generate-report-button" class="px-4 py-2 font-bold bg-green-600 rounded-lg hover:bg-green-700 transition-colors">Gerar Relatório</button>
                        <button id="toggle-waiting-list-button" class="px-4 py-2 font-bold bg-orange-600 rounded-lg hover:bg-orange-700 transition-colors">Ativar Lista de Espera</button>
                    </div>
                </div>

                <div id="player-date-display" class="text-center mb-8 hidden"></div>

                <div id="presence-list-container" class="hidden">
                     <h3 id="selected-date-title" class="text-4xl font-brand text-amber-400 text-center mb-6"></h3>
                     <div id="presence-slots" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 bg-gray-800 bg-opacity-50 rounded-2xl p-6 border border-gray-700"></div>
                </div>
                
                <div id="waiting-list-container" class="hidden mt-12">
                    <h3 class="text-4xl font-brand text-orange-400 text-center mb-6">LISTA DE ESPERA</h3>
                    <div id="waiting-slots" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 bg-gray-800 bg-opacity-50 rounded-2xl p-6 border border-gray-700"></div>
                </div>

            </div>

            <!-- Outras Abas (sem alterações) -->
            <div id="torneio" class="tab-content hidden"><div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700"><h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">TORNEIOS</h2><p class="text-xl text-center text-gray-300">Em breve, informações sobre o nosso próximo torneio de integração.</p></div></div>
            <div id="informacoes" class="tab-content hidden"><div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700"><h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">INFORMAÇÕES GERAIS</h2><ul class="text-xl text-gray-300 space-y-4 list-disc list-inside"><li><strong>Dias de Jogo:</strong> Terças, Quintas e Sábado.</li><li><strong>Horário:</strong> Das 20:00 às 21:00 (Terça e Quinta) e Das 15:00 às 18:00 (Sábado)</li><li><strong>Local:</strong> R. Bento Gonçalves, 457A - Encantado, Rio de Janeiro - RJ, 20755-000.</li><li><strong>Regras:</strong> Respeito acima de tudo.</li></ul></div></div>
            <div id="album" class="tab-content hidden">
                <div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700">
                    <h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">ÁLBUM DE FOTOS</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <img src="https://raw.githubusercontent.com/brunnorj/Presenca/refs/heads/main/Fotos/Foto1.jpg" alt="Foto da equipa 1" class="rounded-lg shadow-lg aspect-video object-cover cursor-pointer transition-transform duration-300 hover:scale-105">
                        <img src="https://raw.githubusercontent.com/brunnorj/Presenca/refs/heads/main/Fotos/foto2.jpg" alt="Foto da equipa 2" class="rounded-lg shadow-lg aspect-video object-cover cursor-pointer transition-transform duration-300 hover:scale-105">
                        <img src="https://raw.githubusercontent.com/brunnorj/Presenca/refs/heads/main/Fotos/foto3.jpg" alt="Foto da equipa 3" class="rounded-lg shadow-lg aspect-video object-cover cursor-pointer transition-transform duration-300 hover:scale-105">
                        <img src="https://raw.githubusercontent.com/brunnorj/Presenca/refs/heads/main/Fotos/foto4.jpg" alt="Foto da equipa 4" class="rounded-lg shadow-lg aspect-video object-cover cursor-pointer transition-transform duration-300 hover:scale-105">
                        <img src="https://raw.githubusercontent.com/brunnorj/Presenca/refs/heads/main/Fotos/foto5.jpg" alt="Foto da equipa 5" class="rounded-lg shadow-lg aspect-video object-cover cursor-pointer transition-transform duration-300 hover:scale-105">
                        <img src="https://raw.githubusercontent.com/brunnorj/Presenca/refs/heads/main/Fotos/foto7.jpg" alt="Foto da equipa 6" class="rounded-lg shadow-lg aspect-video object-cover cursor-pointer transition-transform duration-300 hover:scale-105">
                        <img src="https://raw.githubusercontent.com/brunnorj/Presenca/refs/heads/main/Fotos/foto9.jpg" alt="Foto da equipa 7" class="rounded-lg shadow-lg aspect-video object-cover cursor-pointer transition-transform duration-300 hover:scale-105">
                        <img src="https://raw.githubusercontent.com/brunnorj/Presenca/refs/heads/main/Fotos/WhatsApp-Image-2025-08-30-at-21.46.23-_1_.jpg" alt="Foto da equipa 8" class="rounded-lg shadow-lg aspect-video object-cover cursor-pointer transition-transform duration-300 hover:scale-105">
                    </div>
                </div>
            </div>
            
            <div id="cadastro" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700">
                        <h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">CADASTRAR JOGADOR</h2>
                        <form id="registration-form" class="space-y-6">
                             <div>
                                <label for="new-username" class="text-xl text-gray-300">Nome do Jogador</label>
                                <input type="text" id="new-username" name="new-username" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                            </div>
                            <div>
                                <label for="new-password" class="text-xl text-gray-300">Senha</label>
                                <input type="password" id="new-password" name="new-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                            </div>
                             <div>
                                <label for="new-photo-url" class="text-xl text-gray-300">URL da Foto (Opcional)</label>
                                <input type="url" id="new-photo-url" name="new-photo-url" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="https://example.com/foto.jpg">
                            </div>
                            <div>
                                 <label for="user-role" class="text-xl text-gray-300">Perfil de Acesso</label>
                                 <select id="user-role" name="user-role" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                     <option value="padrão">Padrão</option>
                                     <option value="administrador">Administrador</option>
                                 </select>
                            </div>
                            <p id="registration-message" class="text-center text-lg"></p>
                            <button type="submit" class="w-full px-4 py-3 font-bold text-lg bg-amber-400 text-gray-900 rounded-lg hover:bg-amber-500">CADASTRAR</button>
                        </form>
                    </div>
                    <div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700">
                        <h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">GERIR JOGADORES</h2>
                        <div id="user-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>

            <!-- ABA Legal (sem alterações) -->
            <div id="legal" class="tab-content hidden">
                <div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700 space-y-12">
                    <div class="legal-content">
                        <h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">TERMOS DE USO</h2>
                        <p><strong>Última atualização:</strong> 23 de setembro de 2025</p>
                        <p>Bem-vindo ao Vôlei da Vila! Ao acessar e usar nosso aplicativo, você concorda em cumprir estes Termos de Uso. Por favor, leia-os com atenção.</p>
                        <h3>1. Aceitação dos Termos</h3>
                        <p>Ao criar uma conta ou usar este serviço, você concorda com estes Termos e com a nossa Política de Privacidade. Se você não concorda com algum destes termos, não utilize o aplicativo.</p>
                        <h3>2. Descrição do Serviço</h3>
                        <p>O aplicativo Vôlei da Vila é uma ferramenta para facilitar a organização dos jogos de vôlei do nosso grupo. Ele permite que os membros marquem presença nos dias de jogo, entrem em listas de espera e que os administradores gerenciem os participantes.</p>
                        <h3>3. Conta do Usuário</h3>
                        <ul>
                            <li><strong>Cadastro:</strong> As contas são criadas por um administrador do sistema.</li>
                            <li><strong>Responsabilidade:</strong> Você é responsável por manter a confidencialidade da sua senha e por todas as atividades que ocorrem na sua conta.</li>
                            <li><strong>Uso Pessoal:</strong> Sua conta é para uso pessoal e intransferível.</li>
                        </ul>
                        <h3>4. Regras de Conduta</h3>
                        <p>Você concorda em usar o aplicativo de forma responsável e respeitosa. É proibido usar o serviço para qualquer finalidade ilegal ou não autorizada.</p>
                        <h3>5. Funções e Responsabilidades do Administrador</h3>
                        <p>Os usuários com perfil de "administrador" têm permissões adicionais, incluindo:</p>
                        <ul>
                            <li>Cadastrar, editar e excluir contas de jogadores.</li>
                            <li>Definir e alterar a data ativa para marcação de presença.</li>
                            <li>Remover a presença de jogadores.</li>
                            <li>Aplicar penalidades (suspensões temporárias) a jogadores.</li>
                            <li>Gerenciar o número de vagas e a lista de espera.</li>
                            <li>Desbloquear contas bloqueadas por inatividade.</li>
                        </ul>
                        <h3>6. Política de Inatividade e Bloqueio de Conta</h3>
                        <ul>
                            <li>Para manter a lista de jogadores ativa e organizada, contas de usuários com perfil "padrão" que permanecerem inativas por mais de <strong>14 (quatorze) dias</strong> consecutivos terão seu acesso bloqueado automaticamente.</li>
                            <li>Um usuário inativo é aquele que não realiza o login no aplicativo dentro do período especificado.</li>
                            <li>Se sua conta for bloqueada, você verá uma mensagem de "Login bloqueado por inatividade". Para reativar sua conta, você deverá entrar em contato com um administrador.</li>
                        </ul>
                        <h3>7. Limitação de Responsabilidade</h3>
                        <p>O aplicativo é fornecido "como está", sem garantias de qualquer tipo. Não nos responsabilizamos por quaisquer perdas ou danos resultantes do uso ou da incapacidade de usar o serviço.</p>
                        <h3>8. Alterações nos Termos</h3>
                        <p>Reservamo-nos o direito de modificar estes Termos a qualquer momento. As alterações entrarão em vigor após a sua publicação no aplicativo. O uso continuado do serviço após as alterações constitui sua aceitação dos novos Termos.</p>
                        <h3>9. Lei Aplicável</h3>
                        <p>Estes Termos serão regidos e interpretados de acordo com as leis da República Federativa do Brasil.</p>
                    </div>
                    <div class="legal-content">
                        <h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">POLÍTICA DE PRIVACIDADE</h2>
                        <p><strong>Última atualização:</strong> 23 de setembro de 2025</p>
                        <p>A sua privacidade é importante para nós. Esta Política de Privacidade explica como o aplicativo Vôlei da Vila ("nós", "nosso") coleta, usa e protege as suas informações pessoais.</p>
                        <h3>1. Informações que Coletamos</h3>
                        <p>Coletamos as seguintes informações quando você é cadastrado no aplicativo:</p>
                        <ul>
                            <li><strong>Nome de Exibição:</strong> O nome pelo qual você será conhecido no aplicativo.</li>
                            <li><strong>Nome de Usuário:</strong> Um identificador único para o seu login.</li>
                            <li><strong>Senha:</strong> Para proteger o acesso à sua conta.</li>
                            <li><strong>Perfil de Acesso:</strong> Define se você é um usuário "padrão" ou "administrador".</li>
                            <li><strong>Data do Último Login:</strong> Registramos la data do seu último acesso para gerenciar a atividade da conta.</li>
                            <li><strong>Registros de Presença:</strong> As datas em que você confirma presença nos jogos.</li>
                        </ul>
                        <h3>2. Como Usamos as Suas Informações</h3>
                        <p>As informações coletadas são usadas exclusivamente para os seguintes propósitos:</p>
                        <ul>
                            <li><strong>Gerenciamento de Presença:</strong> Organizar as listas de presença para os dias de jogo e listas de espera.</li>
                            <li><strong>Controle de Acesso:</strong> Autenticar seu login e garantir que apenas membros autorizados acessem o sistema.</li>
                            <li><strong>Administração Interna:</strong> Permitir que os administradores gerenciem os jogadores, apliquem penalidades e mantenham a organização do grupo.</li>
                            <li><strong>Aplicação de Regras:</strong> Identificar inatividade para aplicar a regra de bloqueio de conta, conforme descrito nos Termos de Uso.</li>
                        </ul>
                        <h3>3. Armazenamento e Segurança dos Dados</h3>
                        <p>Seus dados são armazenados de forma segura na plataforma Firebase do Google. Empregamos medidas de segurança para proteger suas informações contra acesso, alteração ou divulgação não autorizada. Sua senha é armazenada no banco de dados para fins de autenticação.</p>
                        <h3>4. Compartilhamento de Informações</h3>
                        <p>Nós não vendemos, alugamos ou compartilhamos suas informações pessoais com terceiros para fins de marketing. As únicas informações compartilhadas são:</p>
                        <ul>
                            <li>O seu <strong>Nome de Exibição</strong> é visível para outros membros do grupo nas listas de presença e de espera.</li>
                            <li>O nome de um convidado que você levar será visível para os outros membros na lista de presença do dia.</li>
                        </ul>
                        <h3>5. Seus Direitos</h3>
                        <p>Você tem o direito de:</p>
                        <ul>
                            <li><strong>Acessar suas informações:</strong> Você pode ver seu nome e perfil no aplicativo.</li>
                            <li><strong>Alterar sua senha:</strong> O aplicativo permite que você altere sua senha a qualquer momento.</li>
                            <li><strong>Solicitar a exclusão da sua conta:</strong> Entre em contato com um administrador para solicitar a remoção completa dos seus dados do sistema.</li>
                        </ul>
                        <h3>6. Alterações a esta Política de Privacidade</h3>
                        <p>Podemos atualizar esta Política de Privacidade periodicamente. Notificaremos sobre quaisquer alterações publicando a nova política nesta página.</p>
                        <h3>7. Contato</h3>
                        <p>Se tiver alguma dúvida sobre esta Política de Privacidade, entre em contato com os administradores do Vôlei da Vila.</p>
                    </div>
                </div>
            </div>
            
            <div id="log" class="tab-content hidden">
                <div class="bg-gray-800 bg-opacity-50 rounded-2xl p-8 border border-gray-700">
                    <h2 class="text-5xl font-brand font-bold text-center mb-6 text-amber-400">REGISTRO DE ATIVIDADES</h2>
                    <div id="log-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </main>
        <footer class="text-center p-4 mt-8 text-gray-400 text-base">
            Copyright 2025 Bruno Sampaio
        </footer>
    </div>

    <div id="image-zoom-modal" class="modal fixed inset-0 bg-black bg-opacity-80 items-center justify-center z-[100] p-4 cursor-pointer">
        <img id="zoomed-image" src="" alt="Imagem ampliada" class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-2xl">
    </div>

    <!-- Modals -->
    <div id="presence-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600 text-center"><h2 id="modal-title" class="text-3xl font-brand text-amber-400">Confirmar Presença</h2><p id="modal-confirm-text" class="text-lg text-gray-200"></p><div class="flex gap-4"><button id="confirm-presence-button" class="w-full py-3 font-bold bg-green-600 rounded-lg hover:bg-green-700">CONFIRMAR</button><button id="cancel-presence-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg hover:bg-gray-500">CANCELAR</button></div></div></div>
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 id="message-title" class="text-3xl font-brand text-amber-400">Aviso</h2><p id="message-text" class="text-lg text-gray-200"></p><button id="message-ok-button" class="px-8 py-2 font-bold bg-amber-400 text-gray-900 rounded-lg hover:bg-amber-500">OK</button></div></div></div>
    <div id="unconfirm-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 class="text-3xl font-brand text-amber-400">Remover Presença</h2><p id="unconfirm-modal-text" class="text-lg text-gray-200"></p><div class="flex gap-4"><button id="confirm-unmark-button" class="w-full py-3 font-bold bg-red-600 rounded-lg hover:bg-red-700">SIM, REMOVER</button><button id="cancel-unmark-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg hover:bg-gray-500">CANCELAR</button></div></div></div>
    <div id="admin-action-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 id="admin-action-title" class="text-3xl font-brand text-amber-400">Ação de Administrador</h2><p id="admin-action-text" class="text-lg text-gray-200"></p><div class="flex flex-col gap-4"><button id="admin-action-view-photo-button" class="w-full py-3 font-bold bg-blue-600 rounded-lg hover:bg-blue-700">Ver Foto</button><button id="admin-action-remove-button" class="w-full py-3 font-bold bg-red-600 rounded-lg hover:bg-red-700">Remover Presença</button><button id="admin-action-penalty-button" class="w-full py-3 font-bold bg-yellow-600 text-gray-900 rounded-lg hover:bg-yellow-700">Aplicar Penalidade</button><button id="admin-action-cancel-button" class="w-full py-2 font-bold bg-gray-600 rounded-lg hover:bg-gray-500 mt-2">Cancelar</button></div></div></div>
    <div id="penalty-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 id="penalty-title" class="text-3xl font-brand text-yellow-500">Aplicar Penalidade</h2><p id="penalty-text" class="text-lg text-gray-200"></p><div class="flex flex-col gap-4"><button data-penalty="7" class="penalty-duration-button w-full py-3 font-bold bg-yellow-600 text-gray-900 rounded-lg">1 Semana</button><button data-penalty="30" class="penalty-duration-button w-full py-3 font-bold bg-orange-600 text-gray-900 rounded-lg">1 Mês</button><button id="penalty-cancel-button" class="w-full py-2 font-bold bg-gray-600 rounded-lg hover:bg-gray-500 mt-2">Cancelar</button></div></div></div>
    <div id="delete-user-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 class="text-3xl font-brand text-red-500">Excluir Jogador</h2><p id="delete-user-text" class="text-lg text-gray-200"></p><div class="flex gap-4"><button id="confirm-delete-user-button" class="w-full py-3 font-bold bg-red-600 rounded-lg hover:bg-red-700">SIM, EXCLUIR</button><button id="cancel-delete-user-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg hover:bg-gray-500">CANCELAR</button></div></div></div>
    <div id="delete-presences-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600"><h2 class="text-3xl font-brand text-red-500">Excluir Presenças</h2><p id="delete-presences-text" class="text-lg text-gray-200"></p><div class="flex gap-4"><button id="confirm-delete-presences-button" class="w-full py-3 font-bold bg-red-600 rounded-lg hover:bg-red-700">SIM, EXCLUIR TUDO</button><button id="cancel-delete-presences-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg hover:bg-gray-500">CANCELAR</button></div></div></div>
    <div id="edit-user-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600"><h2 id="edit-user-title" class="text-3xl font-brand text-amber-400">Editar Jogador</h2><form id="edit-user-form" class="space-y-4"><div><label for="edit-password" class="text-xl text-gray-300">Nova Senha (deixe em branco)</label><input type="password" id="edit-password" name="edit-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white"></div><div><label for="edit-photo-url" class="text-xl text-gray-300">URL da Foto</label><input type="url" id="edit-photo-url" name="edit-photo-url" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white"></div><div><label for="edit-user-role" class="text-xl text-gray-300">Perfil</label><select id="edit-user-role" name="edit-user-role" class="mt-2 w-full px-4 py-3 bg-gray-700 rounded-lg text-white"><option value="padrão">Padrão</option><option value="administrador">Administrador</option></select></div><div class="flex gap-4 pt-4"><button type="submit" class="w-full py-3 font-bold bg-blue-600 hover:bg-blue-700 rounded-lg">GUARDAR</button><button type="button" id="cancel-edit-user-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CANCELAR</button></div></form></div></div>
    <div id="change-password-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600"><h2 class="text-3xl font-brand text-amber-400 text-center">Alterar Senha</h2><form id="change-password-form" class="space-y-4"><div><label for="current-password" class="text-xl text-gray-300">Senha Atual</label><input type="password" id="current-password" name="current-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required></div><div><label for="new-user-password" class="text-xl text-gray-300">Nova Senha</label><input type="password" id="new-user-password" name="new-user-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required></div><div><label for="confirm-new-password" class="text-xl text-gray-300">Confirmar Nova Senha</label><input type="password" id="confirm-new-password" name="confirm-new-password" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required></div><div class="flex gap-4 pt-4"><button type="submit" class="w-full py-3 font-bold bg-amber-400 text-gray-900 hover:bg-amber-500 rounded-lg">GUARDAR ALTERAÇÕES</button><button type="button" id="cancel-change-password-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CANCELAR</button></div></form></div></div>
    <div id="guest-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600"><h2 class="text-3xl font-brand text-sky-400 text-center">Adicionar Convidado</h2><form id="guest-form" class="space-y-4"><div><label for="guest-name" class="text-xl text-gray-300">Nome do Convidado</label><input type="text" id="guest-name" name="guest-name" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required></div><div class="flex gap-4 pt-4"><button type="submit" class="w-full py-3 font-bold bg-sky-500 hover:bg-sky-600 rounded-lg">CONFIRMAR CONVIDADO</button><button type="button" id="cancel-guest-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CANCELAR</button></div></form></div></div>
    
    <!-- MODAL DE OBSERVAÇÃO -->
    <div id="observation-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600">
            <h2 class="text-3xl font-brand text-amber-400 text-center">Adicionar Observação</h2>
            <p class="text-gray-300 text-center">Se desejar, adicione uma observação (ex: "Vou chegar atrasado").</p>
            <form id="observation-form" class="space-y-4">
                <div>
                    <label for="observation-text" class="sr-only">Observação</label>
                    <textarea id="observation-text" name="observation-text" rows="3" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Escreva aqui..."></textarea>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="w-full py-3 font-bold bg-green-600 hover:bg-green-700 rounded-lg">GUARDAR E CONFIRMAR</button>
                    <button type="button" id="skip-observation-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CONFIRMAR SEM OBS.</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL PARA VER OBSERVAÇÃO -->
    <div id="view-observation-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 text-center border border-gray-600">
            <h2 id="view-observation-title" class="text-3xl font-brand text-amber-400">Observação do Jogador</h2>
            <p id="view-observation-text" class="text-lg text-gray-200 bg-gray-700 p-4 rounded-lg whitespace-pre-wrap text-left"></p>
            <button id="view-observation-ok-button" class="px-8 py-2 font-bold bg-amber-400 text-gray-900 rounded-lg hover:bg-amber-500">OK</button>
        </div>
    </div>

    <!-- MODAL FOTO DO JOGADOR (NOVO) -->
    <div id="player-photo-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-[60] p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-xs space-y-4 text-center border border-gray-600 relative">
            <button id="close-player-photo-button" class="absolute top-2 right-3 text-gray-400 hover:text-white">&times;</button>
            <img id="player-photo-img" src="" alt="Foto do Jogador" class="w-40 h-40 rounded-full mx-auto border-4 border-amber-400 object-cover bg-gray-700">
            <h2 id="player-photo-name" class="text-4xl font-brand text-amber-400"></h2>
            <button id="photo-modal-unconfirm-btn" class="hidden w-full py-2 font-bold bg-red-600 rounded-lg hover:bg-red-700 mt-2">REMOVER PRESENÇA</button>
        </div>
    </div>

    <!-- Modal para Mover Jogador da Lista de Espera -->
    <div id="move-player-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600">
            <h2 id="move-player-title" class="text-3xl font-brand text-cyan-400 text-center">Mover Jogador</h2>
            <p id="move-player-text" class="text-lg text-gray-200 text-center"></p>
            <div>
                <label for="free-slots-select" class="text-xl text-gray-300">Escolha uma vaga livre:</label>
                <select id="free-slots-select" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white"></select>
            </div>
            <div class="flex gap-4 pt-4">
                <button id="confirm-move-player-button" class="w-full py-3 font-bold bg-cyan-600 hover:bg-cyan-700 rounded-lg">MOVER</button>
                <button type="button" id="cancel-move-player-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CANCELAR</button>
            </div>
        </div>
    </div>


    <!-- MODAIS DE RELATÓRIO -->
    <div id="report-date-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md space-y-4 border border-gray-600">
            <h2 class="text-3xl font-brand text-green-400 text-center">Gerar Relatório de Presença</h2>
            <form id="report-date-form" class="space-y-4">
                <div>
                    <label for="start-date" class="text-xl text-gray-300">Data de Início</label>
                    <input type="date" id="start-date" name="start-date" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                </div>
                 <div>
                    <label for="end-date" class="text-xl text-gray-300">Data Final</label>
                    <input type="date" id="end-date" name="end-date" class="mt-2 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="w-full py-3 font-bold bg-green-600 hover:bg-green-700 rounded-lg">GERAR</button>
                    <button type="button" id="cancel-report-date-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">CANCELAR</button>
                </div>
            </form>
        </div>
    </div>
    <div id="report-display-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 p-4">
         <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-2xl space-y-4 border border-gray-600">
            <h2 class="text-3xl font-brand text-green-400 text-center">Relatório de Presença</h2>
            <pre id="report-content" class="bg-gray-900 text-white p-4 rounded-lg h-96 overflow-y-auto text-sm whitespace-pre-wrap"></pre>
            <div class="flex gap-4 pt-4">
                <button id="download-report-button" class="w-full py-3 font-bold bg-blue-600 hover:bg-blue-700 rounded-lg">BAIXAR RELATÓRIO</button>
                <button id="close-report-display-button" class="w-full py-3 font-bold bg-gray-600 rounded-lg">FECHAR</button>
            </div>
        </div>
    </div>


    <!-- SCRIPTS DO FIREBASE -->
    <script type="module">
        // Importa as funções que precisamos do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, setDoc, deleteDoc, query, where, updateDoc, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE (IMPORTANTE!) ---
        const firebaseConfig = {
          apiKey: "AIzaSyBRJIBPTlphfKMhGJEz6IGQXAnkuGyY3Po",
          authDomain: "voleidavila-690c6.firebaseapp.com",
          projectId: "voleidavila-690c6",
          storageBucket: "voleidavila-690c6.appspot.com",
          messagingSenderId: "162439328929",
          appId: "1:162439328929:web:5aa41c21408234ca51ace0"
        };

        // Inicializa o Firebase e o Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTES E VARIÁVEIS GLOBAIS ---
            let totalSlots = 24;
            const WAITING_LIST_SLOTS = 5;
            
            // --- ELEMENTOS DA UI ---
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logout-button');
            const welcomeMessage = document.getElementById('welcome-message');
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const adminTabButton = document.getElementById('admin-tab-button');
            const registrationForm = document.getElementById('registration-form');
            const userList = document.getElementById('user-list');
            const presenceModal = document.getElementById('presence-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalConfirmText = document.getElementById('modal-confirm-text');
            const confirmBtn = document.getElementById('confirm-presence-button');
            const cancelBtn = document.getElementById('cancel-presence-button');
            const messageModal = document.getElementById('message-modal');
            const messageTitle = document.getElementById('message-title');
            const messageText = document.getElementById('message-text');
            const messageOkButton = document.getElementById('message-ok-button');
            const unconfirmModal = document.getElementById('unconfirm-modal');
            const unconfirmModalText = document.getElementById('unconfirm-modal-text');
            const confirmUnmarkBtn = document.getElementById('confirm-unmark-button');
            const cancelUnmarkBtn = document.getElementById('cancel-unmark-button');
            const adminActionModal = document.getElementById('admin-action-modal');
            const adminActionTitle = document.getElementById('admin-action-title');
            const adminActionText = document.getElementById('admin-action-text');
            const adminActionViewPhotoButton = document.getElementById('admin-action-view-photo-button');
            const adminActionRemoveBtn = document.getElementById('admin-action-remove-button');
            const adminActionPenaltyBtn = document.getElementById('admin-action-penalty-button');
            const adminActionCancelBtn = document.getElementById('admin-action-cancel-button');
            const penaltyModal = document.getElementById('penalty-modal');
            const penaltyText = document.getElementById('penalty-text');
            const penaltyCancelBtn = document.getElementById('penalty-cancel-button');
            const deleteUserModal = document.getElementById('delete-user-modal');
            const deleteUserText = document.getElementById('delete-user-text');
            const confirmDeleteUserBtn = document.getElementById('confirm-delete-user-button');
            const cancelDeleteUserBtn = document.getElementById('cancel-delete-user-button');
            const deletePresencesModal = document.getElementById('delete-presences-modal');
            const deletePresencesText = document.getElementById('delete-presences-text');
            const confirmDeletePresencesBtn = document.getElementById('confirm-delete-presences-button');
            const cancelDeletePresencesBtn = document.getElementById('cancel-delete-presences-button');
            const editUserModal = document.getElementById('edit-user-modal');
            const editUserTitle = document.getElementById('edit-user-title');
            const editUserForm = document.getElementById('edit-user-form');
            const cancelEditUserBtn = document.getElementById('cancel-edit-user-button');
            const adminDateSelector = document.getElementById('admin-date-selector');
            const adminControls = document.getElementById('admin-controls');
            const pauseDateButton = document.getElementById('pause-date-button');
            const deletePresencesButton = document.getElementById('delete-presences-button');
            const playerDateDisplay = document.getElementById('player-date-display');
            const presenceDateInput = document.getElementById('presence-date');
            const presenceListContainer = document.getElementById('presence-list-container');
            const selectedDateTitle = document.getElementById('selected-date-title');
            const presenceSlots = document.getElementById('presence-slots');
            const changePasswordButton = document.getElementById('change-password-button');
            const changePasswordModal = document.getElementById('change-password-modal');
            const changePasswordForm = document.getElementById('change-password-form');
            const cancelChangePasswordButton = document.getElementById('cancel-change-password-button');
            const guestControls = document.getElementById('guest-controls');
            const addGuestButton = document.getElementById('add-guest-button');
            const guestModal = document.getElementById('guest-modal');
            const guestForm = document.getElementById('guest-form');
            const cancelGuestButton = document.getElementById('cancel-guest-button');
            // Elementos de Relatório
            const generateReportButton = document.getElementById('generate-report-button');
            const reportDateModal = document.getElementById('report-date-modal');
            const reportDateForm = document.getElementById('report-date-form');
            const cancelReportDateButton = document.getElementById('cancel-report-date-button');
            const reportDisplayModal = document.getElementById('report-display-modal');
            const reportContent = document.getElementById('report-content');
            const downloadReportButton = document.getElementById('download-report-button');
            const closeReportDisplayButton = document.getElementById('close-report-display-button');
            const set18SlotsButton = document.getElementById('set-18-slots-button');
            const set24SlotsButton = document.getElementById('set-24-slots-button');
            const currentSlotsDisplay = document.getElementById('current-slots-display');
            // Elementos da Lista de Espera
            const toggleWaitingListButton = document.getElementById('toggle-waiting-list-button');
            const waitingListContainer = document.getElementById('waiting-list-container');
            const waitingSlots = document.getElementById('waiting-slots');
            const movePlayerModal = document.getElementById('move-player-modal');
            const movePlayerTitle = document.getElementById('move-player-title');
            const movePlayerText = document.getElementById('move-player-text');
            const freeSlotsSelect = document.getElementById('free-slots-select');
            const confirmMovePlayerButton = document.getElementById('confirm-move-player-button');
            const cancelMovePlayerButton = document.getElementById('cancel-move-player-button');
            // Elementos do Log
            const logList = document.getElementById('log-list');
            const albumContainer = document.getElementById('album');
            const imageZoomModal = document.getElementById('image-zoom-modal');
            const zoomedImage = document.getElementById('zoomed-image');
            // Elementos do Modal de Observação
            const observationModal = document.getElementById('observation-modal');
            const observationForm = document.getElementById('observation-form');
            const observationText = document.getElementById('observation-text');
            const skipObservationButton = document.getElementById('skip-observation-button');
            const viewObservationModal = document.getElementById('view-observation-modal');
            const viewObservationTitle = document.getElementById('view-observation-title');
            const viewObservationText = document.getElementById('view-observation-text');
            const viewObservationOkButton = document.getElementById('view-observation-ok-button');
            // Elementos do Modal de Foto do Jogador
            const playerPhotoModal = document.getElementById('player-photo-modal');
            const playerPhotoImg = document.getElementById('player-photo-img');
            const playerPhotoName = document.getElementById('player-photo-name');
            const closePlayerPhotoButton = document.getElementById('close-player-photo-button');
            const photoModalUnconfirmBtn = document.getElementById('photo-modal-unconfirm-btn');

            let currentSlotData = null; 
            let selectedPlayerForAction = null;
            let playerToMove = null;
            let userToEditId = null;
            let userToDeleteId = null;
            let userToDeleteName = null;

            // --- FUNÇÕES DE LOG ---
            async function logAction(description) {
                try {
                    const user = sessionStorage.getItem('loggedInUser') || 'Sistema';
                    await addDoc(collection(db, "logs"), {
                        timestamp: new Date(),
                        user: user,
                        action: description
                    });
                } catch (error) {
                    console.error("Erro ao registrar ação no log: ", error);
                }
            }
            
            async function renderLogs() {
                logList.innerHTML = '<p class="text-center">A carregar registos...</p>';
                try {
                    const q = query(collection(db, "logs"));
                    const querySnapshot = await getDocs(q);
                    const logs = [];
                    querySnapshot.forEach((doc) => logs.push(doc.data()));
                    logs.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                    if (logs.length === 0) {
                        logList.innerHTML = '<p class="text-center text-gray-400">Nenhuma atividade registada ainda.</p>';
                        return;
                    }

                    logList.innerHTML = logs.map(logEntry => {
                        const date = logEntry.timestamp.toDate();
                        const formattedDate = `${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR')}`;
                        return `
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <p class="text-white"><strong class="text-amber-400">${logEntry.user}</strong>: ${logEntry.action}</p>
                                <p class="text-xs text-gray-400 text-right">${formattedDate}</p>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error("Erro ao carregar logs: ", error);
                    logList.innerHTML = '<p class="text-center text-red-500">Falha ao carregar os registos.</p>';
                }
            }

            // --- FUNÇÕES GERAIS ---
            function showMessage(title, text) {
                messageTitle.textContent = title;
                messageText.textContent = text;
                messageModal.classList.add('flex');
            }

            function getFormattedDateWithTime(dateString) {
                const dateObj = new Date(dateString + 'T00:00:00');
                const dayOfWeek = dateObj.getDay(); 
                const datePart = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
                let timePart = '';
                if (dayOfWeek === 2 || dayOfWeek === 4) { 
                    timePart = 'das 20:00 as 21:00';
                } else if (dayOfWeek === 6) {
                    timePart = 'das 15:00 as 18:00';
                }
                return `${datePart}${timePart ? `, ${timePart}` : ''}`;
            }
            
            function updatePresenceViewForRole(role, activeDate, isPaused, isWaitingListActive) {
                playerDateDisplay.classList.add('hidden');
                adminDateSelector.classList.add('hidden');
                presenceListContainer.classList.add('hidden');
                waitingListContainer.classList.add('hidden');
                
                if (role === 'administrador') {
                    adminDateSelector.classList.add('flex');
                    adminDateSelector.classList.remove('hidden');
                    presenceDateInput.value = activeDate || '';
                    if (activeDate) {
                        adminControls.classList.remove('hidden');
                        pauseDateButton.textContent = isPaused ? 'Retomar Marcações' : 'Pausar Marcações';
                        renderSlotsForDate(activeDate, isPaused);
                        if (isWaitingListActive) {
                            renderWaitingList(activeDate); 
                            waitingListContainer.classList.remove('hidden');
                        }
                    } else {
                        adminControls.classList.add('hidden');
                    }
                } else {
                    playerDateDisplay.classList.remove('hidden');
                    if (activeDate) {
                        const fullFormattedDate = getFormattedDateWithTime(activeDate);
                        let statusText = isPaused ? '<span class="font-bold text-yellow-500">(Marcações Pausadas)</span>' : '';
                        playerDateDisplay.innerHTML = `<p class="text-2xl">Data ativa: <span class="font-bold text-amber-400">${fullFormattedDate}</span> ${statusText}</p>`;
                        renderSlotsForDate(activeDate, isPaused);
                        if (isWaitingListActive) {
                            renderWaitingList(activeDate);
                            waitingListContainer.classList.remove('hidden');
                        }
                    } else {
                        playerDateDisplay.innerHTML = `<p class="text-2xl text-red-500 font-bold">A aguardar a libertação da data.</p>`;
                    }
                }
            }
            
            async function refreshUI() {
                try {
                    const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                    const settings = configDoc.exists() ? configDoc.data() : { 
                        data_ativa: null, 
                        marcacoes_pausadas: false, 
                        numero_vagas: 24,
                        lista_espera_ativa: false 
                    };
                    totalSlots = settings.numero_vagas || 24;
                    const userRole = sessionStorage.getItem('userRole');
                    if (userRole) {
                        updatePresenceViewForRole(userRole, settings.data_ativa, settings.marcacoes_pausadas, settings.lista_espera_ativa);
                    }
                    if(userRole === 'administrador') {
                        currentSlotsDisplay.textContent = `(Ativas: ${totalSlots})`;
                        toggleWaitingListButton.textContent = settings.lista_espera_ativa ? 'Desativar Lista de Espera' : 'Ativar Lista de Espera';
                        renderUserList();
                    }
                } catch (error) {
                    console.error("Erro ao atualizar a UI: ", error);
                    showMessage("Erro de Conexão", "Não foi possível carregar os dados. Verifique a sua ligação à internet.");
                }
            }
            
            // --- GESTÃO DE UTILIZADORES ---
            async function renderUserList() {
                userList.innerHTML = '<p class="text-center">A carregar jogadores...</p>';
                try {
                    const querySnapshot = await getDocs(query(collection(db, "jogadores")));
                    userList.innerHTML = '';
                    const users = [];
                    querySnapshot.forEach((doc) => users.push({ id: doc.id, ...doc.data() }));

                    users.sort((a, b) => a.nome_exibicao.localeCompare(b.nome_exibicao)).forEach(user => {
                        const penaltyInfo = user.penalidade_ate ? `<p class="text-xs text-red-400">Penalizado até ${new Date(user.penalidade_ate + 'T00:00:00').toLocaleDateString('pt-BR')}</p>` : '';
                        const removePenaltyButton = user.penalidade_ate ? `<button data-userid="${user.id}" data-username="${user.nome_exibicao}" class="remove-penalty-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm">Remover Penalidade</button>` : '';
                        const isBlocked = user.bloqueado_inatividade === true;
                        const blockedInfo = isBlocked ? `<p class="text-xs text-red-500 font-bold">LOGIN BLOQUEADO</p>` : '';
                        const unblockButton = isBlocked ? `<button data-userid="${user.id}" data-username="${user.nome_exibicao}" class="unblock-user-btn bg-teal-500 hover:bg-teal-600 text-white font-bold py-1 px-3 rounded text-sm">Desbloquear</button>` : '';

                        const userEl = document.createElement('div');
                        userEl.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                        userEl.innerHTML = `
                            <div>
                                <p class="font-bold text-white text-lg">${user.nome_exibicao}</p>
                                <p class="text-sm text-amber-400 capitalize">${user.perfil}</p>
                                ${penaltyInfo} ${blockedInfo}
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 items-end">
                                ${unblockButton} ${removePenaltyButton}
                                <button data-userid="${user.id}" data-username="${user.nome_exibicao}" data-userrole="${user.perfil}" data-photourl="${user.photo_url || ''}" class="edit-user-btn bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded text-sm">Editar</button>
                                <button data-userid="${user.id}" data-username="${user.nome_exibicao}" class="delete-user-btn bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded text-sm">Excluir</button>
                            </div>`;
                        userList.appendChild(userEl);
                        if (user.nome_exibicao === sessionStorage.getItem('loggedInUser')) {
                            userEl.querySelectorAll('.edit-user-btn, .delete-user-btn').forEach(btn => {
                                btn.disabled = true;
                                btn.classList.add('opacity-50', 'cursor-not-allowed');
                            });
                        }
                    });
                } catch (error) {
                    console.error("Erro ao renderizar a lista de utilizadores: ", error);
                    userList.innerHTML = '<p class="text-center text-red-500">Falha ao carregar jogadores.</p>';
                }
            }

            async function handleUnblockUser(userId, userName) {
                try {
                    await updateDoc(doc(db, "jogadores", userId), { bloqueado_inatividade: false, ultimo_login: new Date().toISOString().split('T')[0] });
                    logAction(`Desbloqueou o jogador ${userName} por inatividade.`);
                    showMessage('Sucesso', 'O jogador foi desbloqueado.');
                    renderUserList();
                } catch (error) {
                    showMessage("Erro", "Não foi possível desbloquear o jogador.");
                }
            }
            
            async function handleSaveUserChanges(e) {
                e.preventDefault();
                const newPassword = editUserForm['edit-password'].value;
                const newRole = editUserForm['edit-user-role'].value;
                let newPhotoUrl = editUserForm['edit-photo-url'].value.trim();
                
                try {
                    const userRef = doc(db, "jogadores", userToEditId);
                    const userDoc = await getDoc(userRef);
                    const userName = userDoc.exists() ? userDoc.data().nome_exibicao : '';
                    
                    if (!newPhotoUrl && userName) {
                        newPhotoUrl = `https://placehold.co/400x400/FBBF24/001f3f?text=${userName.charAt(0)}`;
                    }

                    const updateData = { perfil: newRole, photo_url: newPhotoUrl };
                    if (newPassword) updateData.senha = newPassword;
                    await updateDoc(userRef, updateData);
                    
                    logAction(`Editou os dados do jogador ${userName}.`);
                    
                    showMessage('Sucesso', 'Dados do jogador atualizados.');
                    editUserModal.classList.remove('flex');
                    renderUserList();
                } catch (error) {
                    showMessage("Erro", "Não foi possível guardar as alterações.");
                }
            }
            
            async function handleChangePassword(e) {
                e.preventDefault();
                const currentPassword = changePasswordForm['current-password'].value;
                const newPassword = changePasswordForm['new-user-password'].value;
                const confirmPassword = changePasswordForm['confirm-new-password'].value;

                if (newPassword !== confirmPassword) return showMessage("Erro", "As novas senhas não coincidem.");
                if (newPassword.length < 4) return showMessage("Erro", "A nova senha deve ter pelo menos 4 caracteres.");

                const userId = sessionStorage.getItem('loggedInUserId');
                if (!userId) return showMessage("Erro", "Sessão inválida. Por favor, faça o login novamente.");

                try {
                    const userRef = doc(db, "jogadores", userId);
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists() && userDoc.data().senha === currentPassword) {
                        await updateDoc(userRef, { senha: newPassword });
                        logAction(`Alterou a própria senha.`);
                        showMessage("Sucesso", "Senha alterada com sucesso!");
                        changePasswordModal.classList.remove('flex');
                    } else {
                        showMessage("Erro", "A senha atual está incorreta ou o utilizador não foi encontrado.");
                    }
                } catch (error) {
                    showMessage("Erro", "Não foi possível alterar a sua senha. Tente novamente.");
                }
            }
            
            async function handleConfirmDeleteUser() {
                try {
                    await deleteDoc(doc(db, "jogadores", userToDeleteId));
                    logAction(`Excluiu o jogador ${userToDeleteName}.`);
                    showMessage('Sucesso', 'Jogador excluído do sistema.');
                    deleteUserModal.classList.remove('flex');
                    renderUserList();
                } catch (error) {
                    showMessage("Erro", "Não foi possível excluir o jogador.");
                }
            }

            async function handleRemovePenalty(userId, userName) {
                try {
                    await updateDoc(doc(db, "jogadores", userId), { penalidade_ate: null });
                    logAction(`Removeu a penalidade do jogador ${userName}.`);
                    showMessage('Sucesso', 'A penalidade do jogador foi removida.');
                    renderUserList();
                } catch (error) {
                    showMessage("Erro", "Não foi possível remover a penalidade.");
                }
            }
            
            // --- LÓGICA DE PRESENÇA ---
            async function renderSlotsForDate(dateString, isPaused) {
                presenceListContainer.classList.remove('hidden');
                selectedDateTitle.textContent = `Presença para ${getFormattedDateWithTime(dateString)}`;
                presenceSlots.innerHTML = '<p class="col-span-full text-center">A carregar...</p>';
                
                const loggedInUserId = sessionStorage.getItem('loggedInUserId');
                const userRole = sessionStorage.getItem('userRole');
                
                try {
                    const playersSnapshot = await getDocs(collection(db, "jogadores"));
                    const playersMap = new Map();
                    playersSnapshot.forEach(d => {
                        const data = d.data();
                        playersMap.set(d.id, {
                            name: data.nome_exibicao,
                            photoUrl: data.photo_url || `https://placehold.co/400x400/FBBF24/001f3f?text=${data.nome_exibicao.charAt(0)}`
                        });
                    });

                    const presenceSnapshot = await getDocs(query(collection(db, "presencas"), where("data_jogo", "==", dateString)));
                    const presences = {};
                    presenceSnapshot.forEach(d => {
                        const data = d.data();
                        const playerData = playersMap.get(data.jogador_id);
                        const playerName = data.tipo === 'convidado' ? data.nome_convidado : (playerData ? playerData.name : 'Desconhecido');
                        const playerPhoto = data.tipo === 'convidado' ? `https://placehold.co/400x400/38bdf8/001f3f?text=C` : (playerData ? playerData.photoUrl : '');

                        if (playerName) presences[data.numero_vaga] = { playerName, playerId: data.jogador_id, docId: d.id, type: data.tipo || 'jogador', observation: data.observacao || '', photoUrl: playerPhoto };
                    });
                    
                    presenceSlots.innerHTML = '';
                    presenceSlots.classList.toggle('admin-view', userRole === 'administrador');

                    let userHasPresence = false;
                    for (let i = 0; i < totalSlots; i++) {
                        const presenceData = presences[i];
                        const slotEl = document.createElement('div');
                        slotEl.dataset.slot = i;
                        slotEl.className = 'slot p-3 rounded-lg text-center font-bold truncate';

                        if (isPaused) {
                            slotEl.classList.add('slot-paused');
                            slotEl.textContent = presenceData ? presenceData.playerName : `#${i + 1}`;
                        } else {
                            if (presenceData) {
                                slotEl.textContent = presenceData.playerName;
                                slotEl.dataset.docId = presenceData.docId;
                                slotEl.dataset.playerName = presenceData.playerName;
                                slotEl.dataset.playerId = presenceData.playerId;
                                slotEl.dataset.type = presenceData.type;
                                slotEl.dataset.photoUrl = presenceData.photoUrl;
                                
                                if (presenceData.playerId === loggedInUserId) {
                                    slotEl.classList.add(presenceData.type === 'convidado' ? 'slot-guest-mine' : 'slot-mine');
                                    if (presenceData.type !== 'convidado') userHasPresence = true;
                                } else {
                                    slotEl.classList.add(presenceData.type === 'convidado' ? 'slot-guest' : 'slot-taken');
                                }
                                if (presenceData.observation && userRole === 'administrador') {
                                    const icon = document.createElement('div');
                                    icon.className = 'observation-icon';
                                    icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7.005 3.1a1 1 0 1 1 1.99 0l-.388 6.35a.61.61 0 0 1-1.214 0zM7 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0"/></svg>`;
                                    icon.dataset.observation = presenceData.observation;
                                    icon.dataset.playerName = presenceData.playerName;
                                    slotEl.appendChild(icon);
                                }
                            } else {
                                slotEl.textContent = `#${i + 1}`;
                                slotEl.classList.add('slot-free');
                            }
                            slotEl.addEventListener('click', handleSlotClick);
                        }
                        presenceSlots.appendChild(slotEl);
                    }
                    guestControls.classList.toggle('hidden', !userHasPresence || isPaused);

                } catch (error) {
                    console.error("Erro ao renderizar vagas: ", error);
                    presenceSlots.innerHTML = '<p class="col-span-full text-center text-red-500">Falha ao carregar presenças.</p>';
                }
            }

            async function handleSlotClick(event) {
                const iconTarget = event.target.closest('.observation-icon');
                if (iconTarget) {
                    viewObservationTitle.textContent = `Observação de ${iconTarget.dataset.playerName}`;
                    viewObservationText.textContent = iconTarget.dataset.observation;
                    viewObservationModal.classList.add('flex');
                    return;
                }

                const target = event.target.closest('.slot');
                if (!target) return;

                const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                if (configDoc.exists() && configDoc.data().marcacoes_pausadas) return;

                // Populate currentSlotData for all cases except free slot
                if (!target.classList.contains('slot-free')) {
                    currentSlotData = {
                        slot: target.dataset.slot,
                        docId: target.dataset.docId,
                        playerName: target.dataset.playerName,
                        playerId: target.dataset.playerId,
                        type: target.dataset.type,
                        list: 'presence', // Assuming this is only for presence list clicks for now
                        photoUrl: target.dataset.photoUrl
                    };
                    selectedPlayerForAction = { name: currentSlotData.playerName, id: currentSlotData.playerId, type: currentSlotData.type };
                }

                const userRole = sessionStorage.getItem('userRole');
                const isMySlot = target.classList.contains('slot-mine') || target.classList.contains('slot-guest-mine');

                // Case 1: Admin clicking an occupied slot
                if (userRole === 'administrador' && !target.classList.contains('slot-free')) {
                    adminActionText.textContent = `Escolha uma ação para ${currentSlotData.playerName}:`;
                    adminActionModal.classList.add('flex');
                    return;
                }

                // Case 2: Any user clicking a free slot
                if (target.classList.contains('slot-free')) {
                    currentSlotData = { slot: target.dataset.slot }; // Set only the necessary part
                    modalTitle.textContent = `Confirmar Vaga #${parseInt(target.dataset.slot) + 1}`;
                    modalConfirmText.textContent = `Confirma a presença para ${sessionStorage.getItem('loggedInUser')}?`;
                    confirmBtn.onclick = handleConfirmPresence;
                    presenceModal.classList.add('flex');
                    return;
                }

                // Case 3: Non-admin clicking any occupied slot (theirs or others)
                if (currentSlotData.playerName && currentSlotData.photoUrl) {
                    playerPhotoImg.src = currentSlotData.photoUrl;
                    playerPhotoName.textContent = currentSlotData.playerName;
                    
                    // Show/hide the unconfirm button based on whether it's the user's slot
                    photoModalUnconfirmBtn.classList.toggle('hidden', !isMySlot);

                    playerPhotoModal.classList.add('flex');
                }
            }
            
            async function setTotalSlots(count) {
                try {
                    await setDoc(doc(db, "configuracoes", "global"), { numero_vagas: count }, { merge: true });
                    logAction(`Alterou o número de vagas para ${count}.`);
                    showMessage('Sucesso', `O número de vagas foi definido para ${count}.`);
                    refreshUI();
                } catch (error) {
                    showMessage("Erro", "Não foi possível alterar o número de vagas.");
                }
            }

            async function handleGuestSubmit(e) {
                e.preventDefault();
                const guestName = guestForm['guest-name'].value.trim();
                if (!guestName) return showMessage("Erro", "Por favor, insira o nome do convidado.");

                const firstFreeSlot = document.querySelector('#presence-slots .slot-free');
                if (!firstFreeSlot) {
                    guestModal.classList.remove('flex');
                    return showMessage("Erro", "Não há mais vagas disponíveis.");
                }

                try {
                    const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                    if (!configDoc.exists() || !configDoc.data().data_ativa) throw new Error("No active date set.");

                    await addDoc(collection(db, "presencas"), {
                        data_jogo: configDoc.data().data_ativa,
                        jogador_id: sessionStorage.getItem('loggedInUserId'),
                        numero_vaga: parseInt(firstFreeSlot.dataset.slot),
                        tipo: 'convidado',
                        nome_convidado: guestName,
                        observacao: ''
                    });
                    logAction(`Adicionou o convidado "${guestName}".`);
                    guestModal.classList.remove('flex');
                    refreshUI();
                } catch(error) {
                    showMessage("Erro", "Não foi possível adicionar o convidado.");
                }
            }
            
            async function handleConfirmPresence() {
                presenceModal.classList.remove('flex');
                confirmBtn.onclick = null;
                observationForm.reset();
                observationModal.classList.add('flex');
            }

            async function handleSavePresenceWithObservation(observation) {
                observationModal.classList.remove('flex');
                const loggedInUserId = sessionStorage.getItem('loggedInUserId');

                try {
                    const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                    if (!configDoc.exists() || !configDoc.data().data_ativa) return showMessage('Erro', 'Nenhuma data ativa para marcação.');
                    
                    const activeDate = configDoc.data().data_ativa;
                    const presencasRef = collection(db, "presencas");

                    const [userSnapshot, slotSnapshot] = await Promise.all([
                        getDocs(query(presencasRef, where("data_jogo", "==", activeDate), where("jogador_id", "==", loggedInUserId), where("tipo", "==", "jogador"))),
                        getDocs(query(presencasRef, where("data_jogo", "==", activeDate), where("numero_vaga", "==", parseInt(currentSlotData.slot))))
                    ]);

                    if (!userSnapshot.empty) return showMessage('Já Confirmado', 'Você já tem presença confirmada para esta data.');
                    if (!slotSnapshot.empty) {
                        showMessage('Vaga Ocupada', 'Esta vaga foi ocupada. A lista será atualizada.');
                        return refreshUI();
                    }

                    await addDoc(presencasRef, { data_jogo: activeDate, jogador_id: loggedInUserId, numero_vaga: parseInt(currentSlotData.slot), tipo: 'jogador', observacao: observation });
                    
                    logAction(`Marcou presença na vaga #${parseInt(currentSlotData.slot) + 1}${observation ? ` com a observação: "${observation}"` : '.'}`);
                    refreshUI();
                } catch (error) {
                    showMessage("Erro", "Não foi possível marcar a presença. Tente novamente.");
                    refreshUI();
                }
            }
            
            async function handleConfirmUnmark() {
                if (!currentSlotData || !currentSlotData.docId) return;
                const collectionName = currentSlotData.list === 'waiting' ? 'lista_espera' : 'presencas';
                try {
                    const batch = writeBatch(db);
                    batch.delete(doc(db, collectionName, currentSlotData.docId));

                    if (currentSlotData.type === 'jogador' && collectionName === 'presencas') {
                        const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                        const activeDate = configDoc.data()?.data_ativa;
                        if (activeDate) {
                            const guestsSnapshot = await getDocs(query(collection(db, "presencas"), where("data_jogo", "==", activeDate), where("jogador_id", "==", currentSlotData.playerId), where("tipo", "==", "convidado")));
                            guestsSnapshot.forEach(guestDoc => batch.delete(guestDoc.ref));
                        }
                    }

                    await batch.commit();
                    logAction(`Removeu ${sessionStorage.getItem('userRole') === 'administrador' && sessionStorage.getItem('loggedInUserId') !== currentSlotData.playerId ? currentSlotData.playerName : 'sua própria presença'} da ${collectionName === 'presencas' ? 'lista de presença' : 'lista de espera'}.`);
                    
                    [unconfirmModal, adminActionModal].forEach(m => m.classList.remove('flex'));
                    
                    if (collectionName === 'presencas' && sessionStorage.getItem('userRole') === 'administrador') {
                         const waitingSnapshot = await getDocs(query(collection(db, "lista_espera"), where("data_jogo", "==", (await getDoc(doc(db, "configuracoes", "global"))).data().data_ativa)));
                         if (!waitingSnapshot.empty) showMessage('Vaga Liberada!', `Existem ${waitingSnapshot.size} jogador(es) na lista de espera.`);
                    }
                    refreshUI();
                } catch (error) {
                    showMessage("Erro", "Não foi possível remover a presença.");
                }
            }

            async function handlePenalty(days) {
                if (selectedPlayerForAction.type === 'convidado') {
                    penaltyModal.classList.remove('flex');
                    return showMessage('Aviso', 'A penalidade só pode ser aplicada a jogadores registados.');
                }
                try {
                    const penaltyEndDate = new Date();
                    penaltyEndDate.setDate(penaltyEndDate.getDate() + days);
                    await updateDoc(doc(db, "jogadores", selectedPlayerForAction.id), { penalidade_ate: penaltyEndDate.toISOString().split('T')[0] });
                    
                    logAction(`Aplicou penalidade de ${days} dias a ${selectedPlayerForAction.name}.`);
                    await handleConfirmUnmark(); 
                    showMessage('Sucesso', `${selectedPlayerForAction.name} foi penalizado e removido da lista.`);
                    penaltyModal.classList.remove('flex');
                    renderUserList();
                } catch (error) {
                    showMessage("Erro", "Não foi possível aplicar a penalidade.");
                }
            }

            // --- LÓGICA DA LISTA DE ESPERA ---
            async function renderWaitingList(dateString) {
                waitingSlots.innerHTML = '';
                try {
                    const playersSnapshot = await getDocs(collection(db, "jogadores"));
                    const playersMap = new Map();
                    playersSnapshot.forEach(d => playersMap.set(d.id, d.data().nome_exibicao));

                    const waitingSnapshot = await getDocs(query(collection(db, "lista_espera"), where("data_jogo", "==", dateString)));
                    const waitingList = {};
                    waitingSnapshot.forEach(d => {
                        const data = d.data();
                        if (playersMap.has(data.jogador_id)) waitingList[data.numero_vaga] = { playerName: playersMap.get(data.jogador_id), playerId: data.jogador_id, docId: d.id };
                    });

                    waitingSlots.classList.toggle('admin-view', sessionStorage.getItem('userRole') === 'administrador');
                    
                    for (let i = 0; i < WAITING_LIST_SLOTS; i++) {
                        const waitingData = waitingList[i];
                        const slotEl = document.createElement('div');
                        slotEl.dataset.slot = i;
                        slotEl.className = 'slot p-3 rounded-lg text-center font-bold truncate';

                        if (waitingData) {
                            slotEl.textContent = waitingData.playerName;
                            slotEl.dataset.docId = waitingData.docId;
                            slotEl.dataset.playerName = waitingData.playerName;
                            slotEl.dataset.playerId = waitingData.playerId;
                            slotEl.classList.add('slot-waiting');
                            if (waitingData.playerId === sessionStorage.getItem('loggedInUserId')) slotEl.classList.add('slot-waiting-mine');
                        } else {
                            slotEl.textContent = `Espera #${i + 1}`;
                            slotEl.classList.add('slot-free');
                        }
                        slotEl.addEventListener('click', handleWaitingSlotClick);
                        waitingSlots.appendChild(slotEl);
                    }
                } catch (error) {
                    console.error("Erro ao renderizar lista de espera:", error);
                    waitingSlots.innerHTML = '<p class="col-span-full text-red-500">Falha ao carregar.</p>';
                }
            }

            async function handleWaitingSlotClick(event) {
                const target = event.target.closest('.slot');
                if (!target) return;
                const userRole = sessionStorage.getItem('userRole');
                currentSlotData = { slot: target.dataset.slot, docId: target.dataset.docId, playerName: target.dataset.playerName, playerId: target.dataset.playerId, list: 'waiting' };
                
                if (target.classList.contains('slot-free')) {
                    modalTitle.textContent = 'Entrar na Lista de Espera';
                    modalConfirmText.textContent = `Deseja entrar na vaga de espera #${parseInt(currentSlotData.slot) + 1}?`;
                    confirmBtn.onclick = handleConfirmWaitingPresence;
                    presenceModal.classList.add('flex');
                } else if (target.classList.contains('slot-waiting-mine')) {
                    unconfirmModalText.textContent = `Deseja sair da lista de espera?`;
                    confirmUnmarkBtn.onclick = handleConfirmUnmark;
                    unconfirmModal.classList.add('flex');
                } else if (userRole === 'administrador') {
                    const freeSlots = Array.from(document.querySelectorAll('#presence-slots .slot-free')).map(s => s.dataset.slot);
                    if (freeSlots.length === 0) return showMessage('Sem Vagas', 'Não há vagas livres na lista de presença para mover este jogador.');
                    
                    playerToMove = { name: currentSlotData.playerName, id: currentSlotData.playerId, waitingDocId: currentSlotData.docId };
                    movePlayerText.textContent = `Mover ${playerToMove.name} para a lista de presença.`;
                    freeSlotsSelect.innerHTML = freeSlots.map(s => `<option value="${s}">Vaga #${parseInt(s) + 1}</option>`).join('');
                    movePlayerModal.classList.add('flex');
                }
            }

            async function handleConfirmWaitingPresence() {
                presenceModal.classList.remove('flex');
                const loggedInUserId = sessionStorage.getItem('loggedInUserId');
                try {
                    const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                    if (!configDoc.exists() || !configDoc.data().data_ativa) return showMessage('Erro', 'Nenhuma data ativa para marcação.');
                    
                    const activeDate = configDoc.data().data_ativa;
                    const waitingListRef = collection(db, "lista_espera");
                    const presencasRef = collection(db, "presencas");

                    const [userPresenceSnap, userWaitingSnap, slotWaitingSnap] = await Promise.all([
                        getDocs(query(presencasRef, where("data_jogo", "==", activeDate), where("jogador_id", "==", loggedInUserId))),
                        getDocs(query(waitingListRef, where("data_jogo", "==", activeDate), where("jogador_id", "==", loggedInUserId))),
                        getDocs(query(waitingListRef, where("data_jogo", "==", activeDate), where("numero_vaga", "==", parseInt(currentSlotData.slot))))
                    ]);

                    if (!userPresenceSnap.empty || !userWaitingSnap.empty) return showMessage('Aviso', 'Você já está na lista de presença ou de espera.');
                    if (!slotWaitingSnap.empty) {
                        showMessage('Vaga Ocupada', 'Esta vaga na lista de espera foi ocupada.');
                        return refreshUI();
                    }

                    await addDoc(waitingListRef, { data_jogo: activeDate, jogador_id: loggedInUserId, numero_vaga: parseInt(currentSlotData.slot) });
                    logAction(`Entrou na lista de espera (vaga #${parseInt(currentSlotData.slot) + 1}).`);
                    refreshUI();
                } catch (error) {
                    showMessage('Erro', 'Não foi possível entrar na lista de espera.');
                }
            }

            async function handleConfirmMovePlayer() {
                if (!playerToMove) return;
                try {
                    const configDoc = await getDoc(doc(db, "configuracoes", "global"));
                    const activeDate = configDoc.data().data_ativa;

                    const batch = writeBatch(db);
                    batch.delete(doc(db, "lista_espera", playerToMove.waitingDocId));
                    batch.set(doc(collection(db, "presencas")), { data_jogo: activeDate, jogador_id: playerToMove.id, numero_vaga: parseInt(freeSlotsSelect.value), tipo: 'jogador', observacao: 'Movido da lista de espera.' });
                    await batch.commit();

                    logAction(`Moveu ${playerToMove.name} da lista de espera para a vaga #${parseInt(freeSlotsSelect.value) + 1}.`);
                    showMessage('Sucesso', `${playerToMove.name} foi movido para a lista de presença.`);
                    movePlayerModal.classList.remove('flex');
                    refreshUI();
                } catch(error) {
                    showMessage('Erro', 'Não foi possível mover o jogador.');
                }
            }
            
            async function handleToggleWaitingList() {
                try {
                    const configRef = doc(db, "configuracoes", "global");
                    const configDoc = await getDoc(configRef);
                    const currentStatus = configDoc.data()?.lista_espera_ativa || false;
                    await setDoc(configRef, { lista_espera_ativa: !currentStatus }, { merge: true });
                    logAction(`${!currentStatus ? 'Ativou' : 'Desativou'} a lista de espera.`);
                    showMessage('Sucesso', `Lista de espera ${!currentStatus ? 'ativada' : 'desativada'}.`);
                    refreshUI();
                } catch (error) {
                    showMessage("Erro", "Não foi possível alterar o estado da lista de espera.");
                }
            }

            // --- LÓGICA DE RELATÓRIO ---
            async function handleGenerateReport(e) {
                e.preventDefault();
                const startDate = reportDateForm['start-date'].value, endDate = reportDateForm['end-date'].value;
                if (!startDate || !endDate || startDate > endDate) return showMessage('Erro', 'Selecione um intervalo de datas válido.');

                reportDateModal.classList.remove('flex');
                reportDisplayModal.classList.add('flex');
                reportContent.textContent = 'A gerar relatório...';

                try {
                    const playersSnap = await getDocs(collection(db, "jogadores"));
                    const playersMap = new Map(), presenceCounts = {};
                    playersSnap.forEach(d => {
                        playersMap.set(d.id, d.data().nome_exibicao);
                        presenceCounts[d.data().nome_exibicao] = 0;
                    });
                    const guestCounts = {};
                    const presenceSnap = await getDocs(query(collection(db, "presencas"), where("data_jogo", ">=", startDate), where("data_jogo", "<=", endDate)));
                    presenceSnap.forEach(d => {
                        const data = d.data();
                        if (data.tipo === 'jogador') {
                            const playerName = playersMap.get(data.jogador_id);
                            if (playerName) presenceCounts[playerName]++;
                        } else if (data.tipo === 'convidado') {
                            const hostName = playersMap.get(data.jogador_id);
                            const guestKey = `${data.nome_convidado} (convidado por ${hostName || '?'})`;
                            guestCounts[guestKey] = (guestCounts[guestKey] || 0) + 1;
                        }
                    });

                    const sortedPlayers = Object.entries(presenceCounts).sort(([,a],[,b]) => b-a);
                    const sortedGuests = Object.entries(guestCounts).sort(([,a],[,b]) => b-a);
                    const formattedStart = new Date(startDate + 'T00:00:00').toLocaleDateString('pt-BR');
                    const formattedEnd = new Date(endDate + 'T00:00:00').toLocaleDateString('pt-BR');
                    
                    let reportString = `Relatório de Presença - ${formattedStart} a ${formattedEnd}\n============================================\n\n--- JOGADORES ---\n`;
                    sortedPlayers.forEach(([name, count]) => reportString += `${name}: ${count} presença(s)\n`);
                    if (sortedGuests.length > 0) {
                        reportString += '\n--- CONVIDADOS ---\n';
                        sortedGuests.forEach(([name, count]) => reportString += `${name}: ${count} presença(s)\n`);
                    }
                    reportContent.textContent = reportString;
                } catch (error) {
                    reportContent.textContent = 'Ocorreu um erro ao gerar o relatório.';
                }
            }

            function handleDownloadReport() {
                const blob = new Blob([reportContent.textContent], { type: 'text/plain' });
                const anchor = document.createElement('a');
                anchor.href = URL.createObjectURL(blob);
                anchor.download = `relatorio_presenca.txt`;
                anchor.click();
                URL.revokeObjectURL(anchor.href);
            }

            // --- AUTENTICAÇÃO E NAVEGAÇÃO ---
            function handleTabClick(event) {
                tabs.forEach(tab => tab.classList.remove('active'));
                event.currentTarget.classList.add('active');
                const tabId = event.currentTarget.dataset.tab;
                if (tabId === 'log') renderLogs();
                tabContents.forEach(content => content.classList.toggle('hidden', content.id !== tabId));
            }
            
            async function handleLogin(e) {
                e.preventDefault();
                const loginErrorEl = document.getElementById('login-error');
                loginErrorEl.classList.add('hidden');
                
                const username = loginForm.username.value.toLowerCase().replace(/\s+/g, '');
                const password = loginForm.password.value;
                
                try {
                    const qSnapshot = await getDocs(query(collection(db, "jogadores"), where("nome_usuario", "==", username)));
                    if (qSnapshot.empty) throw new Error('Utilizador ou senha inválidos.');
                    
                    const userDoc = qSnapshot.docs[0];
                    const userData = userDoc.data();

                    if (userData.bloqueado_inatividade) throw new Error('Login bloqueado por inatividade.');
                    if (userData.senha !== password) throw new Error('Utilizador ou senha inválidos.');
                    
                    if (userData.penalidade_ate) {
                        const today = new Date(); today.setHours(0,0,0,0);
                        if (today <= new Date(userData.penalidade_ate + 'T00:00:00')) throw new Error(`Está penalizado até ${new Date(userData.penalidade_ate + 'T00:00:00').toLocaleDateString('pt-BR')}.`);
                    }
                    
                    if (userData.perfil === 'padrão' && userData.ultimo_login && (new Date() - new Date(userData.ultimo_login)) / (1000*60*60*24) > 14) {
                        await updateDoc(userDoc.ref, { bloqueado_inatividade: true });
                        throw new Error('Login bloqueado por inatividade.');
                    }

                    await updateDoc(userDoc.ref, { ultimo_login: new Date().toISOString().split('T')[0] });
                    sessionStorage.setItem('loggedInUserId', userDoc.id);
                    sessionStorage.setItem('loggedInUser', userData.nome_exibicao);
                    sessionStorage.setItem('userRole', userData.perfil);
                    
                    showApp(userData.nome_exibicao, userData.perfil);
                    refreshUI();
                } catch (error) {
                    loginErrorEl.textContent = error.message || 'Erro de conexão. Tente novamente.';
                    loginErrorEl.classList.remove('hidden');
                }
            }

            function handleLogout() {
                sessionStorage.clear();
                appScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                document.getElementById('log-tab-button').classList.add('hidden');
                adminTabButton.classList.add('hidden');
                loginForm.reset();
            }
            
            async function handleRegistration(e) {
                e.preventDefault();
                const msgEl = document.getElementById('registration-message');
                const newUsername = registrationForm['new-username'].value;
                let photoUrl = registrationForm['new-photo-url'].value.trim();

                if (!photoUrl) photoUrl = `https://placehold.co/400x400/FBBF24/001f3f?text=${newUsername.charAt(0)}`;
                
                try {
                    const normalized = newUsername.toLowerCase().replace(/\s+/g, '');
                    const qSnapshot = await getDocs(query(collection(db, "jogadores"), where("nome_usuario", "==", normalized)));
                    if (!qSnapshot.empty) throw new Error("Este jogador já existe.");

                    await addDoc(collection(db, "jogadores"), {
                        nome_exibicao: newUsername,
                        nome_usuario: normalized,
                        senha: registrationForm['new-password'].value,
                        perfil: registrationForm['user-role'].value,
                        photo_url: photoUrl,
                        ultimo_login: new Date().toISOString().split('T')[0],
                    });

                    logAction(`Cadastrou o novo jogador: ${newUsername}.`);
                    msgEl.textContent = "Jogador cadastrado!";
                    msgEl.className = "text-center text-lg text-green-500";
                    registrationForm.reset();
                    renderUserList();
                } catch (error) {
                    msgEl.textContent = error.message || "Erro ao cadastrar.";
                    msgEl.className = "text-center text-lg text-red-500";
                }
            }
            
            function showApp(username, role) {
                welcomeMessage.textContent = `Bem-vindo(a), ${username}!`;
                adminTabButton.classList.toggle('hidden', role !== 'administrador');
                document.getElementById('log-tab-button').classList.toggle('hidden', role !== 'administrador');
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
            }

            // --- INICIALIZAÇÃO ---
            function main() {
                if(sessionStorage.getItem('loggedInUser')) {
                    showApp(sessionStorage.getItem('loggedInUser'), sessionStorage.getItem('userRole'));
                    refreshUI();
                }
                
                loginForm.addEventListener('submit', handleLogin);
                logoutButton.addEventListener('click', handleLogout);
                tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
                registrationForm.addEventListener('submit', handleRegistration);
                editUserForm.addEventListener('submit', handleSaveUserChanges);
                confirmDeleteUserBtn.addEventListener('click', handleConfirmDeleteUser);
                messageOkButton.addEventListener('click', () => messageModal.classList.remove('flex'));
                set18SlotsButton.addEventListener('click', () => setTotalSlots(18));
                set24SlotsButton.addEventListener('click', () => setTotalSlots(24));
                changePasswordButton.addEventListener('click', () => changePasswordModal.classList.add('flex'));
                cancelChangePasswordButton.addEventListener('click', () => changePasswordModal.classList.remove('flex'));
                changePasswordForm.addEventListener('submit', handleChangePassword);
                addGuestButton.addEventListener('click', () => guestModal.classList.add('flex'));
                cancelGuestButton.addEventListener('click', () => guestModal.classList.remove('flex'));
                guestForm.addEventListener('submit', handleGuestSubmit);
                cancelBtn.addEventListener('click', () => presenceModal.classList.remove('flex'));
                cancelUnmarkBtn.addEventListener('click', () => unconfirmModal.classList.remove('flex'));
                confirmUnmarkBtn.addEventListener('click', handleConfirmUnmark);
                adminActionCancelBtn.addEventListener('click', () => adminActionModal.classList.remove('flex'));
                adminActionViewPhotoButton.addEventListener('click', () => {
                    if (currentSlotData && currentSlotData.photoUrl) {
                        adminActionModal.classList.remove('flex');
                        playerPhotoImg.src = currentSlotData.photoUrl;
                        playerPhotoName.textContent = currentSlotData.playerName;
                        photoModalUnconfirmBtn.classList.add('hidden'); // Admin shouldn't unconfirm from here
                        playerPhotoModal.classList.add('flex');
                    }
                });
                adminActionRemoveBtn.addEventListener('click', () => { adminActionModal.classList.remove('flex'); handleConfirmUnmark(); });
                adminActionPenaltyBtn.addEventListener('click', () => { adminActionModal.classList.remove('flex'); penaltyText.textContent = `Aplicar penalidade para ${selectedPlayerForAction.name}.`; penaltyModal.classList.add('flex'); });
                penaltyCancelBtn.addEventListener('click', () => penaltyModal.classList.remove('flex'));
                document.querySelectorAll('.penalty-duration-button').forEach(b => b.addEventListener('click', (e) => handlePenalty(parseInt(e.target.dataset.penalty))));
                toggleWaitingListButton.addEventListener('click', handleToggleWaitingList);
                cancelMovePlayerButton.addEventListener('click', () => movePlayerModal.classList.remove('flex'));
                confirmMovePlayerButton.addEventListener('click', handleConfirmMovePlayer);
                userList.addEventListener('click', (e) => {
                    if (e.target.matches('.edit-user-btn')) {
                        userToEditId = e.target.dataset.userid;
                        editUserTitle.textContent = `Editar ${e.target.dataset.username}`;
                        editUserForm['edit-user-role'].value = e.target.dataset.userrole;
                        editUserForm['edit-photo-url'].value = e.target.dataset.photourl || '';
                        editUserModal.classList.add('flex');
                    } else if (e.target.matches('.delete-user-btn')) {
                        userToDeleteId = e.target.dataset.userid;
                        userToDeleteName = e.target.dataset.username;
                        deleteUserText.textContent = `Tem a certeza de que quer excluir ${userToDeleteName}?`;
                        deleteUserModal.classList.add('flex');
                    } else if (e.target.matches('.remove-penalty-btn')) {
                        handleRemovePenalty(e.target.dataset.userid, e.target.dataset.username);
                    } else if (e.target.matches('.unblock-user-btn')) {
                        handleUnblockUser(e.target.dataset.userid, e.target.dataset.username);
                    }
                });
                cancelEditUserBtn.addEventListener('click', () => editUserModal.classList.remove('flex'));
                cancelDeleteUserBtn.addEventListener('click', () => deleteUserModal.classList.remove('flex'));
                observationForm.addEventListener('submit', (e) => { e.preventDefault(); handleSavePresenceWithObservation(observationText.value.trim()); });
                skipObservationButton.addEventListener('click', () => handleSavePresenceWithObservation(''));
                viewObservationOkButton.addEventListener('click', () => viewObservationModal.classList.remove('flex'));
                closePlayerPhotoButton.addEventListener('click', () => playerPhotoModal.classList.remove('flex'));

                photoModalUnconfirmBtn.addEventListener('click', () => {
                    playerPhotoModal.classList.remove('flex');
                    unconfirmModalText.textContent = `Tem a certeza de que deseja remover a presença de ${currentSlotData.playerName}?`;
                    unconfirmModal.classList.add('flex');
                });
                
                presenceDateInput.addEventListener('change', async (e) => { try { await setDoc(doc(db, "configuracoes", "global"), { data_ativa: e.target.value, marcacoes_pausadas: false }, { merge: true }); logAction(`Alterou a data ativa.`); refreshUI(); } catch (error) { console.error(error); }});
                pauseDateButton.addEventListener('click', async () => { try { const configRef = doc(db, "configuracoes", "global"); const currentStatus = (await getDoc(configRef)).data()?.marcacoes_pausadas || false; await setDoc(configRef, { marcacoes_pausadas: !currentStatus }, { merge: true }); logAction(`${!currentStatus ? 'Pausou' : 'Retomou'} as marcações.`); refreshUI(); } catch (error) { console.error(error); }});
                deletePresencesButton.addEventListener('click', async () => { const activeDate = (await getDoc(doc(db, "configuracoes", "global"))).data()?.data_ativa; if (!activeDate) return showMessage('Aviso', 'Nenhuma data ativa selecionada.'); deletePresencesText.textContent = `Apagar TODAS as presenças do dia ${new Date(activeDate + 'T00:00:00').toLocaleDateString('pt-BR')}?`; deletePresencesModal.classList.add('flex'); });
                cancelDeletePresencesBtn.addEventListener('click', () => deletePresencesModal.classList.remove('flex'));
                confirmDeletePresencesBtn.addEventListener('click', async () => {
                    try {
                        const activeDate = (await getDoc(doc(db, "configuracoes", "global"))).data()?.data_ativa;
                        if (!activeDate) return;
                        const [presencesSnap, waitingSnap] = await Promise.all([ getDocs(query(collection(db, "presencas"), where("data_jogo", "==", activeDate))), getDocs(query(collection(db, "lista_espera"), where("data_jogo", "==", activeDate))) ]);
                        const batch = writeBatch(db);
                        presencesSnap.forEach(d => batch.delete(d.ref));
                        waitingSnap.forEach(d => batch.delete(d.ref));
                        await batch.commit();
                        await setDoc(doc(db, "configuracoes", "global"), { data_ativa: null }, { merge: true });
                        logAction(`Excluiu todas as presenças do dia ${activeDate}.`);
                        showMessage('Sucesso', 'Presenças removidas e data desativada.');
                        deletePresencesModal.classList.remove('flex');
                        refreshUI();
                    } catch(error) { showMessage("Erro", "Não foi possível excluir as presenças."); }
                });
                generateReportButton.addEventListener('click', () => reportDateModal.classList.add('flex'));
                cancelReportDateButton.addEventListener('click', () => reportDateModal.classList.remove('flex'));
                reportDateForm.addEventListener('submit', handleGenerateReport);
                downloadReportButton.addEventListener('click', handleDownloadReport);
                closeReportDisplayButton.addEventListener('click', () => reportDisplayModal.classList.remove('flex'));
                albumContainer.addEventListener('click', (e) => { if (e.target.tagName === 'IMG' && e.target.closest('#album')) { zoomedImage.src = e.target.src; imageZoomModal.classList.add('flex'); } });
                imageZoomModal.addEventListener('click', () => imageZoomModal.classList.remove('flex'));
            }
            main();
        });
    </script>
</body>
</html>

